<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Master 2.1.0</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* --- CORE SETTINGS --- */
        html {
            overflow-y: scroll;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        /* --- BACKGROUND FLICKER FIX --- */
        /* We move the background to a fixed element so the keyboard doesn't resize it */
        #fixed-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -50;
            background-color: #0f172a;
            /* Slate 900 */
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.15), transparent 40%),
                radial-gradient(circle at 100% 100%, rgba(168, 85, 247, 0.15), transparent 40%);
            background-size: 30px 30px, 30px 30px, cover, cover;
        }

        /* --- ANIMATIONS --- */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }

            to {
                transform: translateY(0);
            }
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        @keyframes shine {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .slide-up {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .scale-in {
            animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        .animate-pulse-slow {
            animation: pulse 2s infinite ease-in-out;
        }

        .animate-spin-slow {
            animation: spin 3s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Gradient Title Animation */
        .animate-gradient-text {
            background: linear-gradient(270deg, #818cf8, #c084fc, #818cf8);
            background-size: 200% 200%;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 4s ease infinite;
        }

        /* --- GLASS UI --- */
        .glass-header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- RESPONSIVE & FONT FIXES --- */
        .desktop-only {
            display: none !important;
        }

        .mobile-only {
            display: block !important;
        }

        /* PC Specific Scaling */
        @media (min-width: 1024px) {
            .desktop-only {
                display: block !important;
            }

            .mobile-only {
                display: none !important;
            }

            /* INCREASED FONT SIZE FOR PC */
            body {
                font-size: 16px;
            }

            td {
                font-size: 1rem !important;
            }

            /* Make table text larger */

            /* Desktop enhancements for better UX */
            input,
            select,
            textarea {
                font-size: 16px !important;
                padding: 12px 16px !important;
                min-height: 48px;
            }

            button {
                font-size: 16px !important;
                min-height: 48px;
                padding: 12px 24px !important;
            }

            /* Better spacing */
            .p-6 {
                padding: 2rem !important;
            }

            /* Larger modals */
            .max-w-md {
                max-width: 560px !important;
            }

            .max-w-sm {
                max-width: 500px !important;
            }
        }

        /* --- UTILS --- */
        .text-clamp {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Autofill Fix for Dark Theme */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #1e293b inset !important;
            -webkit-text-fill-color: white !important;
        }

        /* Enhanced Hover Effects */
        .hover-shine {
            position: relative;
            overflow: hidden;
        }

        .hover-shine::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translate(50%, 50%);
        }

        .hover-shine:hover::before {
            opacity: 1;
            transform: translate(0, 0);
        }

        .hover-scale {
            transition: transform 0.2s;
        }

        .hover-scale:hover {
            transform: scale(1.05);
        }

        /* Selective Smooth Transitions - Performance Optimized */
        button,
        a,
        input,
        select,
        textarea {
            transition: all 0.2s ease-in-out;
        }

        .transition-transform {
            transition: transform 0.2s ease-in-out;
        }

        .transition-opacity {
            transition: opacity 0.2s ease-in-out;
        }

        /* Mobile Keyboard Handling */
        body.modal-open {
            position: fixed;
            width: 100%;
            overflow: hidden;
        }

        body.keyboard-open .fixed-modal {
            position: absolute;
            max-height: calc(var(--visual-viewport-height, 100vh) - 20px);
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: loading 1.5s ease-in-out infinite;
        }

        @keyframes loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 9999;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 640px) {
            body {
                font-size: 14px;
            }
        }

        @media (min-width: 641px) and (max-width: 1023px) {
            body {
                font-size: 15px;
            }
        }
    </style>
</head>

<body class="min-h-screen text-slate-300 pb-24 lg:pb-0">
    <div id="fixed-background"></div>
    <div id="app"></div>
    <datalist id="tech-suggestions">
        <option value="Arduino Uno R3">
        <option value="Arduino Nano V3">
        <option value="ESP32 Dev Module">
        <option value="ESP8266 NodeMCU">
        <option value="Raspberry Pi 4">
        <option value="Raspberry Pi Pico W">
        <option value="STM32 Blue Pill">
        <option value="Resistor Kit">
        <option value="Resistor 220Ω">
        <option value="Resistor 1kΩ">
        <option value="Resistor 10kΩ">
        <option value="Capacitor 10uF">
        <option value="LED Red 5mm">
        <option value="WS2812B LED Strip">
        <option value="OLED 0.96 I2C">
        <option value="LCD 16x2">
        <option value="Servo SG90">
        <option value="Stepper NEMA17">
        <option value="Motor Driver L298N">
        <option value="HC-SR04 Ultrasonic">
        <option value="DHT11 Temperature">
        <option value="LiPo Battery 3.7V">
        <option value="Soldering Iron">
        <option value="Multimeter">
        <option value="Breadboard">
        <option value="Jumper Wires">
    </datalist>
    <script>
        // ==========================================
        // 1. CONFIGURATION
        // ==========================================
        var APP_PASSWORD = 'IV9769806390D';
        var SUPABASE_URL = '';
        var SUPABASE_KEY = '';
        var categories = ['Actuators', 'Amplifiers', 'Antennas', 'Audio', 'Batteries', 'Breadboards', 'Breakout Boards', 'Buzzers', 'Cables', 'Capacitors', 'Connectors', 'Crystals', 'Development Boards', 'Diodes', 'Displays', 'Enclosures', 'Encoders', 'Fans', 'Ferrites', 'Fuses', 'Hardware', 'Heat Sinks', 'ICs', 'Inductors', 'IoT Boards', 'Jumper Wires', 'Keypads', 'LEDs', 'Memory', 'Microcontrollers', 'Modules', 'Motors', 'Optoelectronics', 'Oscillators', 'PCBs', 'Potentiometers', 'Power Management', 'Power Supplies', 'Protection', 'Rectifiers', 'Relays', 'Resistors', 'Screws', 'Sensors', 'Servos', 'Sockets', 'Solar', 'Speakers', 'Steppers', 'Switches', 'Terminals', 'Tools', 'Transceivers', 'Transformers', 'Transistors', 'Voltage Regulators', 'Wires', 'Wireless', 'Miscellaneous'].sort();
        // ==========================================
        // ==========================================
        // 2. STATE
        // ==========================================
        var state = {
            activeTab: 'inventory',
            components: [], transactions: [], notes: [], images: [],
            searchTerm: '', filterCategory: 'All', logSearchTerm: '',
            logFilterType: 'All', logFromDate: '', logToDate: '', logFilterCategory: 'All',
            isAuthenticated: false, loading: false,
            showAddModal: false, showSetupModal: false, showStockModal: false, showHistoryModal: false, showNotesModal: false, showAddNoteModal: false, showStorageViewer: false,
            editingId: null, editingNoteId: null,
            stockAction: { id: null, type: 'IN', name: '' },
            historyComponent: { id: null, name: '' },
            dbConfig: { url: SUPABASE_URL, key: SUPABASE_KEY },
            formData: { name: '', category: 'Microcontroller', value: '', quantity: '', location: '', notes: '', cost: '', minStock: '5', datasheet: '', purchasedDate: '', partNumber: '', supplierUrl: '', image: null, imageUrl: '' },
            noteForm: { title: '', content: '', quantity: '', priority: 'Medium', tags: '', dueDate: '', completed: false },
            sortBy: 'name', sortAsc: true,
            filterLowStock: false,
            scrollY: 0,
            imageStorageUsed: 0,
            // Performance & Mobile
            cache: {},
            keyboardOpen: false,
            isMobile: false,
            isTablet: false,
            // Update 2: Advanced Features
            logQuickFilter: '',
            credentialsLocked: true,
            credentialsPassword: localStorage.getItem('credPass') || '',
            showCredentials: false,
            showPasswordModal: false,
            notesSortBy: 'created',
            notesFilterPriority: 'All',
            notesFilterCompleted: 'All'
        };

        // ==========================================
        // 2.5 UTILITY FUNCTIONS
        // ==========================================

        // Simple encryption (Base64 + XOR)
        function encryptData(data, password) {
            if (!password) return data;
            let encrypted = '';
            for (let i = 0; i < data.length; i++) {
                encrypted += String.fromCharCode(data.charCodeAt(i) ^ password.charCodeAt(i % password.length));
            }
            return btoa(encrypted);
        }

        function decryptData(encrypted, password) {
            if (!password) return encrypted;
            try {
                const decoded = atob(encrypted);
                let decrypted = '';
                for (let i = 0; i < decoded.length; i++) {
                    decrypted += String.fromCharCode(decoded.charCodeAt(i) ^ password.charCodeAt(i % password.length));
                }
                return decrypted;
            } catch (e) {
                return encrypted;
            }
        }

        // ==========================================
        // 2.5 UTILITY FUNCTIONS (NEW)
        // ==========================================

        // Device Detection
        function detectDevice() {
            const width = window.innerWidth;
            state.isMobile = width < 768;
            state.isTablet = width >= 768 && width < 1024;
            return { isMobile: state.isMobile, isTablet: state.isTablet };
        }

        // Mobile Keyboard Handling
        function setupKeyboardHandling() {
            // Only track keyboard state, don't interfere with input
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    const keyboardHeight = window.innerHeight - window.visualViewport.height;
                    state.keyboardOpen = keyboardHeight > 100;

                    if (state.keyboardOpen) {
                        document.body.classList.add('keyboard-open');
                    } else {
                        document.body.classList.remove('keyboard-open');
                    }
                });
            }

            // Add keyboard shortcuts for desktop
            document.addEventListener('keydown', (e) => {
                const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                const modKey = isMac ? e.metaKey : e.ctrlKey;

                // Ignore if typing in an input/textarea
                const isTyping = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA';

                // ESC - Close any open modal
                if (e.key === 'Escape') {
                    if (state.showAddModal || state.showStockModal || state.showSetupModal ||
                        state.showHistoryModal || state.showAddNoteModal || state.showStorageViewer ||
                        state.showPasswordModal) {
                        e.preventDefault();
                        state.showAddModal = false;
                        state.showStockModal = false;
                        state.showSetupModal = false;
                        state.showHistoryModal = false;
                        state.showAddNoteModal = false;
                        state.showStorageViewer = false;
                        state.showPasswordModal = false;
                        renderModals();
                    }
                }

                // Don't run other shortcuts if typing
                if (isTyping) return;

                // Ctrl/Cmd + K - Focus search
                if (modKey && e.key === 'k') {
                    e.preventDefault();
                    const searchInput = document.querySelector('input[placeholder*="Search"]');
                    if (searchInput) searchInput.focus();
                }

                // Ctrl/Cmd + N - New component
                if (modKey && e.key === 'n') {
                    e.preventDefault();
                    openAddModal();
                }

                // Ctrl/Cmd + , - Settings
                if (modKey && e.key === ',') {
                    e.preventDefault();
                    state.showSetupModal = true;
                    renderModals();
                }
            });
        }

        // Toast Notification System
        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-emerald-600',
                error: 'bg-rose-600',
                warning: 'bg-amber-600',
                info: 'bg-indigo-600'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${colors[type]} text-white px-6 py-3 rounded-xl shadow-2xl font-semibold max-w-sm`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Performance-Optimized Debounce
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Request Cache (5 min TTL)
        function getCached(key) {
            const cached = state.cache[key];
            if (cached && Date.now() - cached.timestamp < 300000) {
                return cached.data;
            }
            return null;
        }

        function setCache(key, data) {
            state.cache[key] = { data, timestamp: Date.now() };
        }

        // ==========================================
        // 3. INIT & DATA
        // ==========================================
        function init() {
            categories = categories.sort();
            detectDevice(); // New: Device detection
            setupKeyboardHandling(); // New: Mobile keyboard handling

            var auth = sessionStorage.getItem('auth');

            // Security: Try to load encrypted credentials
            var encUrl = localStorage.getItem('sb_url');
            var encKey = localStorage.getItem('sb_key');

            if (encUrl && encKey) {
                // Try to decrypt with APP_PASSWORD
                var decUrl = decryptData(encUrl, APP_PASSWORD);
                var decKey = decryptData(encKey, APP_PASSWORD);

                if (decUrl && decKey) {
                    state.dbConfig = { url: decUrl, key: decKey };
                } else {
                    // Legacy or invalid encryption
                    var savedConfig = localStorage.getItem('dbConfig');
                    if (savedConfig) {
                        state.dbConfig = JSON.parse(savedConfig);
                        // Auto-migrate to encrypted
                        if (state.dbConfig.url && state.dbConfig.key) {
                            localStorage.setItem('sb_url', encryptData(state.dbConfig.url, APP_PASSWORD));
                            localStorage.setItem('sb_key', encryptData(state.dbConfig.key, APP_PASSWORD));
                            localStorage.removeItem('dbConfig'); // Clear plaintext
                        }
                    }
                }
            } else {
                // Fallback to old plaintext method for migration
                var savedConfig = localStorage.getItem('dbConfig');
                if (savedConfig) {
                    state.dbConfig = JSON.parse(savedConfig);
                    // Auto-migrate to encrypted
                    if (state.dbConfig.url && state.dbConfig.key) {
                        localStorage.setItem('sb_url', encryptData(state.dbConfig.url, APP_PASSWORD));
                        localStorage.setItem('sb_key', encryptData(state.dbConfig.key, APP_PASSWORD));
                        localStorage.removeItem('dbConfig'); // Clear plaintext
                    }
                }
            }

            if (SUPABASE_URL && SUPABASE_KEY) state.dbConfig = { url: SUPABASE_URL, key: SUPABASE_KEY };
            if (auth === 'true') {
                state.isAuthenticated = true;
                if (state.dbConfig.url && state.dbConfig.key) loadData();
            }
            renderApp();

            // Responsive resize listener
            window.addEventListener('resize', debounce(() => {
                detectDevice();
                renderApp();
            }, 250));
        }

        function loadData() {
            if (!state.dbConfig.url) return;

            // Check cache first
            const cacheKey = 'appData';
            const cached = getCached(cacheKey);
            if (cached) {
                state.components = cached.components || [];
                state.transactions = cached.transactions || [];
                state.notes = cached.notes || [];
                renderApp();
                return;
            }

            state.loading = true;
            renderHeader();
            var headers = { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key };
            Promise.all([
                fetch(state.dbConfig.url + '/rest/v1/components?select=*&order=name.asc', { headers }).then(r => r.json()),
                fetch(state.dbConfig.url + '/rest/v1/transactions?select=*,components(name,value,category)&order=created_at.desc', { headers }).then(r => r.json()),
                fetch(state.dbConfig.url + '/rest/v1/notes?select=*&order=created_at.desc', { headers }).then(r => r.json())
            ]).then(([comps, logs, nts]) => {
                state.components = Array.isArray(comps) ? comps : [];
                state.transactions = Array.isArray(logs) ? logs : [];
                state.notes = Array.isArray(nts) ? nts : [];

                // Cache the data
                setCache(cacheKey, {
                    components: state.components,
                    transactions: state.transactions,
                    notes: state.notes
                });

                state.loading = false;
                showToast('Data loaded successfully', 'success');
                renderApp();
            }).catch(e => {
                console.error(e);
                state.loading = false;
                showToast('Failed to load data', 'error');
                renderApp();
            });
        }

        // ==========================================
        // 3.5 SECURITY FUNCTIONS
        // ==========================================
        function toggleCredentials() {
            if (state.credentialsLocked) {
                unlockCredentials();
            } else {
                state.credentialsLocked = true;
                state.showCredentials = false;
                renderModals();
            }
        }

        function unlockCredentials() {
            state.showPasswordModal = true;
            renderModals();
        }

        function verifyPasswordAndUnlock(password) {
            // Validate password is not empty
            if (!password || password.trim() === '') {
                showToast("Please enter a password", "warning");
                return; // Don't close modal or re-render
            }

            if (password === APP_PASSWORD) {
                state.credentialsLocked = false;
                state.showPasswordModal = false;
                showToast("Credentials unlocked", "success");
            } else {
                showToast("Incorrect password", "error");
                // Keep modal open for retry
                return;
            }
            renderModals();
        }

        // ==========================================
        // 4. API INTERACTIONS (SUPABASE)
        // ==========================================
        function verifyConnection() {
            if (!state.dbConfig.url || !state.dbConfig.key) return;
            state.loading = true; renderApp();

            fetch(state.dbConfig.url + '/rest/v1/components?select=count', {
                headers: { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key }
            }).then(r => {
                state.loading = false;
                if (r.ok) {
                    state.isAuthenticated = true;
                    if (!state.components.length) loadData();
                    renderApp();
                    showToast('Connected to Supabase', 'success');
                } else {
                    showToast('Connection failed. Check credentials.', 'error');
                }
            }).catch(e => {
                state.loading = false;
                showToast('Connection error', 'error');
                renderApp();
            });
        }

        async function loadImages() {
            try {
                if (!state.dbConfig.url || !state.dbConfig.key) return;

                const listRes = await fetch(state.dbConfig.url + '/storage/v1/object/list/components/', {
                    method: 'POST', headers: { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prefix: '', limit: 100, sortBy: { column: 'name', order: 'asc' } })
                });
                const data = await listRes.json();
                state.images = data;
                state.imageStorageUsed = 0;
                // Filter out placeholder/folder objects if any
                const validImages = data.filter(img => img.name && img.name !== '.' && !img.name.endsWith('/'));
                state.images = validImages;

                for (const img of validImages) {
                    // Fetch metadata for size
                    if (img.metadata && img.metadata.size) {
                        state.imageStorageUsed += img.metadata.size;
                    } else {
                        // Fallback if metadata not available in list
                        const headRes = await fetch(state.dbConfig.url + '/storage/v1/object/public/components/' + img.name, {
                            method: 'HEAD', headers: { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key }
                        });
                        const size = parseInt(headRes.headers.get('content-length') || '0');
                        state.imageStorageUsed += size;
                    }
                }
                renderModals();
            } catch (e) {
                console.error(e);
                showToast('Failed to load images', 'error');
            }
        }
        // ==========================================
        // 4. MAIN RENDERER
        // ==========================================
        function renderApp() {
            var app = document.getElementById('app');

            if (!state.isAuthenticated) {
                app.innerHTML = getLoginHTML();
                return;
            }
            var shell = document.getElementById('main-shell');
            if (!shell) {
                app.innerHTML = `
                    <div id="main-shell">
                        <div id="header-container"></div>
                        <div id="content-container" class="max-w-7xl mx-auto p-4 md:p-8 fade-in"></div>
                    </div>
                    <div id="modals-container"></div>
                `;
            }
            renderHeader();
            renderContent();
            renderModals();
        }
        // ==========================================
        // 5. LOGIN UI (ANIMATED)
        // ==========================================
        function getLoginHTML() {
            return `
            <div class="min-h-screen flex items-center justify-center p-6 relative overflow-hidden">
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[500px] h-[500px] bg-indigo-600 rounded-full mix-blend-screen filter blur-[120px] opacity-20 animate-pulse"></div>
                <div class="glass-card rounded-3xl p-8 w-full max-w-sm text-center relative z-10 shadow-2xl animate-float">
                    <div class="w-20 h-20 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-indigo-500/30">
                        <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                    </div>
                    <h1 class="text-3xl font-extrabold mb-2 tracking-tight animate-gradient-text">System Access</h1>
                    <p class="text-sm text-slate-400 mb-8 font-mono">Personal Inventory</p>
                   
                    <div class="space-y-4">
                        <input type="password" id="password" class="w-full px-5 py-4 bg-black/40 border border-white/10 rounded-xl outline-none focus:border-indigo-500 text-white placeholder:text-slate-500 font-mono text-center tracking-widest transition-colors" placeholder="PASSCODE" onkeypress="if(event.key==='Enter')handleLogin()">
                        <button id="loginBtn" onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-500/20 hover:bg-indigo-500 transition-all hover:scale-[1.02] flex items-center justify-center gap-2">
                            <span id="loginText">INITIALIZE</span>
                            <svg id="loginSpinner" class="hidden w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>`;
        }
        // ==========================================
        // 6. HEADER (ANIMATED TITLE)
        // ==========================================
        function renderHeader() {
            var container = document.getElementById('header-container');
            if (!container) return;
            var totalVal = state.components.reduce((acc, c) => acc + (c.quantity * (c.cost_per_unit || 0)), 0);
            var lowStockCount = state.components.filter(c => c.quantity <= (c.min_stock_level || 5)).length;
            container.innerHTML = `
                <div class="sticky top-0 z-40 glass-header px-4 py-3 md:px-8 md:py-4">
                    <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center justify-between w-full md:w-auto gap-6">
                            <div class="flex items-center gap-3">
                                <h1 class="text-2xl font-black text-white tracking-tight">
                                    Inventory<span class="animate-gradient-text">Master</span>
                                </h1>
                            </div>
                            <div class="flex bg-slate-800/50 border border-white/10 p-1 rounded-xl">
                                <button onclick="switchTab('inventory')" class="px-4 py-1.5 rounded-lg text-sm font-semibold transition-all ${state.activeTab === 'inventory' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}">Items</button>
                                <button onclick="switchTab('logs')" class="px-4 py-1.5 rounded-lg text-sm font-semibold transition-all ${state.activeTab === 'logs' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}">Logs</button>
                                <button onclick="switchTab('notes')" class="px-4 py-1.5 rounded-lg text-sm font-semibold transition-all ${state.activeTab === 'notes' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}">Notes</button>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 w-full md:w-auto">
                            <div class="grid grid-cols-3 gap-3 flex-1 md:flex-none">
                                <div class="bg-slate-800/50 border border-white/10 rounded-xl px-3 py-2 text-center min-w-[80px] hover-shine">
                                    <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Count</div>
                                    <div class="text-lg font-black text-white">${state.components.length}</div>
                                </div>
                                <div class="bg-slate-800/50 border border-white/10 rounded-xl px-3 py-2 text-center min-w-[80px] hover-shine">
                                    <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Value</div>
                                    <div class="text-lg font-black text-white">₹${totalVal.toLocaleString()}</div>
                                </div>
                                <button onclick="toggleLowStockFilter()" class="bg-slate-800/50 border border-${lowStockCount > 0 ? 'red' : 'slate'}-500/30 rounded-xl px-3 py-2 text-center min-w-[80px] hover-shine ${lowStockCount > 0 ? 'animate-pulse-slow' : ''}">
                                    <div class="text-[10px] text-${lowStockCount > 0 ? 'red' : 'slate'}-400 font-bold uppercase tracking-wider">Alerts</div>
                                    <div class="text-lg font-black text-${lowStockCount > 0 ? 'red' : 'slate'}-500">${lowStockCount}</div>
                                </button>
                            </div>
                            <button onclick="state.showSetupModal=true;renderModals()" class="w-12 h-12 flex items-center justify-center rounded-xl bg-slate-800/50 border border-white/10 text-slate-400 hover:text-white hover:bg-slate-700 transition relative overflow-hidden group hover-shine" title="Settings">
                                <svg class="w-6 h-6 animate-[spin_10s_linear_infinite]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            </button>
                        </div>
                    </div>
                </div>`;
        }
        // ==========================================
        // 7. CONTENT
        // ==========================================
        function renderContent() {
            var container = document.getElementById('content-container');
            if (!container) return;
            if (state.activeTab === 'inventory') {
                container.innerHTML = `
                    <div id="search-controls" class="flex flex-col md:flex-row gap-3 mb-8">
                        <div class="relative flex-1 group">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-slate-400 group-focus-within:text-indigo-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            </div>
                            <input type="text" id="static-search" oninput="handleSearch(this.value)" value="${state.searchTerm}" placeholder="Search components..." class="block w-full pl-10 p-3.5 bg-slate-800/50 border border-slate-700 rounded-xl shadow-lg outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-white font-medium placeholder-slate-500">
                        </div>
                        <select onchange="state.filterCategory=this.value;updateList()" class="p-3.5 bg-slate-800/80 border border-slate-600 rounded-xl shadow-lg outline-none focus:ring-2 focus:ring-indigo-500 font-semibold text-slate-200 cursor-pointer hover:bg-slate-700 transition">
                            <option value="All">All Categories</option>
                            ${categories.map(c => `<option value="${c}" ${state.filterCategory === c ? 'selected' : ''}>${c}</option>`).join('')}
                        </select>
                        <select onchange="handleSort(this.value)" class="p-3.5 bg-slate-800/80 border border-slate-600 rounded-xl shadow-lg outline-none focus:ring-2 focus:ring-indigo-500 font-semibold text-slate-200 cursor-pointer hover:bg-slate-700 transition">
                            <option value="name">Sort by Name</option>
                            <option value="quantity">Sort by Quantity</option>
                            <option value="cost_per_unit">Sort by Cost</option>
                        </select>
                        <button onclick="openAddModal()" class="hidden md:flex bg-indigo-600 hover:bg-indigo-500 text-white px-6 rounded-xl font-bold shadow-lg shadow-indigo-500/30 transition-all items-center gap-2 hover-shine">
                            <span>+ Add Item</span>
                        </button>
                        <button onclick="exportToCSV('inventory')" class="hidden md:flex bg-green-600 hover:bg-green-500 text-white px-6 rounded-xl font-bold shadow-lg shadow-green-500/30 transition-all items-center gap-2 hover-shine">
                            <span>Export Inventory</span>
                        </button>
                    </div>
                   
                    <div id="inventory-list-container" class="fade-in"></div>
                    <button onclick="openAddModal()" class="mobile-only fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 text-white rounded-2xl shadow-xl shadow-indigo-900/50 flex items-center justify-center text-3xl pb-1 z-40 active:scale-90 transition-transform font-light border border-white/20 hover-shine">+</button>
                `;
                updateList();
            } else if (state.activeTab === 'logs') {
                renderLogs(container);
            } else if (state.activeTab === 'notes') {
                renderNotes(container);
            }
        }
        // ==========================================
        // 8. LIST (PC TEXT SIZE INCREASED, ENHANCED HEADERS)
        // ==========================================
        function toggleLowStockFilter() {
            var lowStockCount = state.components.filter(c => c.quantity <= (c.min_stock_level || 5)).length;
            if (lowStockCount === 0) return;
            state.filterLowStock = !state.filterLowStock;
            state.filterCategory = 'All';
            state.searchTerm = '';
            updateList();
        }
        function updateList() {
            var container = document.getElementById('inventory-list-container');
            if (!container) return;
            var filtered = state.components.filter(c => {
                var t = state.searchTerm.toLowerCase();
                return (state.filterCategory === 'All' || c.category === state.filterCategory) &&
                    (c.name.toLowerCase().includes(t) || (c.value && c.value.toLowerCase().includes(t)) || (c.location && c.location.toLowerCase().includes(t)) || (c.notes && c.notes.toLowerCase().includes(t)) || (c.part_number && c.part_number.toLowerCase().includes(t)) || (c.manufacturer && c.manufacturer.toLowerCase().includes(t))) &&
                    (!state.filterLowStock || c.quantity <= (c.min_stock_level || 5));
            });
            // Sort filtered list
            filtered.sort((a, b) => {
                let valA = a[state.sortBy], valB = b[state.sortBy];
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                return state.sortAsc ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
            });
            // MOBILE CARDS
            var mobile = filtered.length === 0 ? '<div class="p-12 text-center text-slate-500 bg-white/5 rounded-xl border border-white/5">No items found.</div>' : filtered.map(c => `
                <div class="bg-white text-slate-800 p-5 mb-4 rounded-2xl shadow-lg shadow-black/5 relative overflow-hidden fade-in border border-slate-100 hover-shine hover-scale">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 ${c.quantity <= (c.min_stock_level || 5) ? 'bg-rose-500' : 'bg-emerald-500'}"></div>
                    <div class="pl-3">
                        <div class="flex justify-between items-start mb-3">
                            <div class="min-w-0 flex-1 mr-3">
                                <h3 class="font-bold text-slate-900 text-lg leading-tight text-clamp">${esc(c.value || c.name)}</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[10px] font-bold uppercase tracking-wider text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100">${esc(c.category)}</span>
                                </div>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <div class="text-3xl font-black text-slate-900 leading-none">${c.quantity}</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <div class="bg-slate-50 rounded-lg px-3 py-2 border border-slate-100">
                                <div class="text-[10px] uppercase text-slate-400 font-bold">Location</div>
                                <div class="text-sm font-semibold text-slate-700 text-clamp">${esc(c.location || '--')}</div>
                            </div>
                            <div class="bg-slate-50 rounded-lg px-3 py-2 border border-slate-100">
                                <div class="text-[10px] uppercase text-slate-400 font-bold">Spec</div>
                                <div class="text-sm font-semibold text-slate-700 text-clamp">${esc(c.value || '--')}</div>
                            </div>
                            <div class="bg-slate-50 rounded-lg px-3 py-2 border border-slate-100">
                                <div class="text-[10px] uppercase text-slate-400 font-bold">Part #</div>
                                <div class="text-sm font-semibold text-slate-700 text-clamp">${esc(c.part_number || '--')}</div>
                            </div>
                            <div class="bg-slate-50 rounded-lg px-3 py-2 border border-slate-100">
                                <div class="text-[10px] uppercase text-slate-400 font-bold">Purchased</div>
                                <div class="text-sm font-semibold text-slate-700 text-clamp">${esc(c.purchased_date ? new Date(c.purchased_date).toLocaleDateString() : '--')}</div>
                            </div>
                        </div>
                        ${c.image_url ? `
                        <div class="mt-3 mb-3">
                            <img src="${c.image_url}" alt="${esc(c.name)}" class="w-full h-32 object-cover rounded-xl border border-slate-200" onerror="this.style.display='none'">
                        </div>
                        ` : ''}
                        <div class="flex gap-2">
                            <button onclick="openStockModal(${c.id}, 'OUT', '${esc(c.name)}')" class="flex-1 bg-rose-50 text-rose-600 py-2.5 rounded-xl font-bold border border-rose-100 active:scale-95 transition hover:bg-rose-100 hover-shine">-</button>
                            <button onclick="openStockModal(${c.id}, 'IN', '${esc(c.name)}')" class="flex-1 bg-emerald-50 text-emerald-600 py-2.5 rounded-xl font-bold border border-emerald-100 active:scale-95 transition hover:bg-emerald-100 hover-shine">+</button>
                            <button onclick="openHistoryModal(${c.id}, '${esc(c.name)}')" class="w-12 bg-yellow-50 text-yellow-600 rounded-xl font-bold border border-yellow-100 flex items-center justify-center active:scale-95 hover:bg-yellow-100 hover-shine">H</button>
                            ${c.datasheet_url ? `<a href="${c.datasheet_url}" target="_blank" class="w-12 bg-blue-50 text-blue-600 rounded-xl font-bold border border-blue-100 flex items-center justify-center active:scale-95 hover:bg-blue-100 hover-shine">PDF</a>` : ''}
                            ${c.supplier_url ? `<a href="${c.supplier_url}" target="_blank" class="w-12 bg-purple-50 text-purple-600 rounded-xl font-bold border border-purple-100 flex items-center justify-center active:scale-95 hover:bg-purple-100 hover-shine">Buy</a>` : ''}
                            <button onclick="openEditModal(${c.id})" class="w-12 bg-slate-100 text-slate-600 rounded-xl font-bold border border-slate-200 active:scale-95 transition hover:bg-slate-200 hover-shine">✎</button>
                        </div>
                    </div>
                </div>
            `).join('');
            // DESKTOP TABLE (Larger Fonts Applied Here, Enhanced Headers)
            var desktopRows = filtered.length === 0 ? '<div class="p-12 text-center text-slate-500 bg-white/5 rounded-xl border border-white/5">No items found matching your search.</div>' : filtered.map(c => `
                <div class="group bg-white text-slate-800 rounded-xl border border-slate-200 shadow-sm hover:shadow-lg hover:border-indigo-300 transition-all duration-200 p-4 mb-3 hover-shine fade-in relative">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 rounded-l-xl ${c.quantity <= (c.min_stock_level || 5) ? 'bg-rose-500' : 'bg-emerald-500'}"></div>
                    <div class="flex items-start gap-4 pl-2">
                        <div class="flex-1 min-w-0">
                            <div class="font-bold text-slate-900 text-xl truncate">${esc(c.value || c.name)}</div>
                            <span class="inline-block mt-1 text-xs font-bold uppercase tracking-wider text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded-md border border-indigo-100">${esc(c.category)}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-[11px] text-slate-400 font-bold uppercase tracking-wider mb-1">Spec</div>
                            <div class="font-semibold text-slate-800 truncate bg-slate-50 px-2 py-0.5 rounded border border-slate-100 text-base">${esc(c.value || '-')}</div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-[11px] text-slate-400 font-bold uppercase tracking-wider mb-1">Part # / Location</div>
                            <div class="font-semibold text-slate-800 truncate text-sm">${esc(c.part_number || '-')} / ${esc(c.location || '-')}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="openStockModal(${c.id}, 'OUT', '${esc(c.name)}')" class="w-8 h-8 rounded-lg bg-rose-50 text-rose-600 font-bold hover:bg-rose-500 hover:text-white transition opacity-0 group-hover:opacity-100 border border-rose-100 hover-shine">-</button>
                            <div class="text-2xl font-black text-slate-900 w-12 text-center">${c.quantity}</div>
                            <button onclick="openStockModal(${c.id}, 'IN', '${esc(c.name)}')" class="w-8 h-8 rounded-lg bg-emerald-50 text-emerald-600 font-bold hover:bg-emerald-500 hover:text-white transition opacity-0 group-hover:opacity-100 border border-emerald-100 hover-shine">+</button>
                        </div>
                        <div class="flex flex-col items-end gap-1">
                            <div class="flex items-center gap-2">
                                <div class="font-mono text-slate-500 font-bold text-sm">₹${c.cost_per_unit || 0}</div>
                                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">${esc(c.purchased_date ? new Date(c.purchased_date).toLocaleDateString() : '-')}</div>
                            </div>
                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="openHistoryModal(${c.id}, '${esc(c.name)}')" class="p-1.5 text-yellow-600 hover:bg-yellow-50 rounded-lg transition hover-shine" title="History"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></button>
                                ${c.datasheet_url ? `<a href="${c.datasheet_url}" target="_blank" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded-lg transition hover-shine" title="PDF"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></a>` : ''}
                                ${c.image_url ? `<a href="${c.image_url}" target="_blank" class="p-1.5 text-orange-600 hover:bg-orange-50 rounded-lg transition hover-shine" title="Image"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></a>` : ''}
                                ${c.supplier_url ? `<a href="${c.supplier_url}" target="_blank" class="p-1.5 text-purple-600 hover:bg-purple-50 rounded-lg transition hover-shine" title="Supplier"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h18v18H3V3z"/></svg></a>` : ''}
                                <button onclick="openEditModal(${c.id})" class="p-1.5 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition hover-shine"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            container.innerHTML = `
                <div class="mobile-only pb-24">${mobile}</div>
                <div class="desktop-only space-y-2">
                    <div class="bg-indigo-600 rounded-xl shadow-md px-4 py-3 mb-3 sticky top-20 z-30">
                        <div class="flex items-center gap-4 pl-2">
                            <div class="flex-1 text-sm uppercase font-bold text-white tracking-wider">Component / Category</div>
                            <div class="flex-1 text-sm uppercase font-bold text-white tracking-wider">Specification</div>
                            <div class="flex-1 text-sm uppercase font-bold text-white tracking-wider">Part # / Location</div>
                            <div class="text-sm uppercase font-bold text-white tracking-wider" style="width: 140px;">Stock</div>
                            <div class="text-sm uppercase font-bold text-white tracking-wider text-right" style="width: 200px;">Cost / Date / Actions</div>
                        </div>
                    </div>
                    ${desktopRows}
                </div>
            `;
        }
        function renderLogs(container) {
            container.innerHTML = `
                <div class="max-w-7xl mx-auto pb-24">
                    <div class="space-y-4 mb-6">
                        <!-- Quick Filters -->
                        <div class="flex flex-wrap gap-2">
                            <button onclick="setQuickLogFilter('today')" class="px-4 py-2 rounded-xl font-semibold transition-transform ${state.logQuickFilter === 'today' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-800/50 text-slate-300 hover:bg-slate-700'} border border-slate-600">Today</button>
                            <button onclick="setQuickLogFilter('week')" class="px-4 py-2 rounded-xl font-semibold transition-transform ${state.logQuickFilter === 'week' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-800/50 text-slate-300 hover:bg-slate-700'} border border-slate-600">This Week</button>
                            <button onclick="setQuickLogFilter('month')" class="px-4 py-2 rounded-xl font-semibold transition-transform ${state.logQuickFilter === 'month' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-800/50 text-slate-300 hover:bg-slate-700'} border border-slate-600">This Month</button>
                            <button onclick="setQuickLogFilter('')" class="px-4 py-2 rounded-xl font-semibold transition-transform ${state.logQuickFilter === '' ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-800/50 text-slate-300 hover:bg-slate-700'} border border-slate-600">All Time</button>
                            <button onclick="clearLogFilters()" class="px-4 py-2 rounded-xl font-semibold transition-transform bg-rose-600/20 text-rose-400 hover:bg-rose-600 hover:text-white border border-rose-600/50">Clear Filters</button>
                        </div>
                        
                        <!-- Search Bar -->
                        <div class="relative w-full">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            </div>
                            <input type="text" oninput="debouncedLogSearch(this.value)" id="log-search-input" placeholder="Search logs..." value="${state.logSearchTerm}" class="block w-full pl-10 p-3.5 bg-slate-800/50 border border-slate-700 rounded-xl shadow-lg outline-none focus:ring-2 focus:ring-indigo-500 transition-transform text-white font-medium placeholder-slate-500" style="color: white !important;">
                        </div>
                        
                        <!-- Filters Row -->
                        <div class="flex flex-col md:flex-row gap-3 items-stretch md:items-center">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 flex-1">
                                <select onchange="state.logFilterType=this.value;debouncedRenderLogs()" class="p-3.5 bg-slate-800/80 border border-slate-600 rounded-xl shadow-lg outline-none focus:ring-2 focus:ring-indigo-500 font-semibold text-slate-200 cursor-pointer hover:bg-slate-700 transition-transform w-full">
                                    <option value="All" ${state.logFilterType === 'All' ? 'selected' : ''}>All Types</option>
                                    <option value="IN" ${state.logFilterType === 'IN' ? 'selected' : ''}>Additions</option>
                                    <option value="OUT" ${state.logFilterType === 'OUT' ? 'selected' : ''}>Removals</option>
                                </select>
                                <select onchange="state.logFilterCategory=this.value;debouncedRenderLogs()" class="p-3.5 bg-slate-800/80 border border-slate-600 rounded-xl shadow-lg outline-none focus:ring-2 focus:ring-indigo-500 font-semibold text-slate-200 cursor-pointer hover:bg-slate-700 transition-transform w-full">
                                    <option value="All" ${state.logFilterCategory === 'All' ? 'selected' : ''}>All Categories</option>
                                    ${categories.map(c => `<option value="${c}" ${state.logFilterCategory === c ? 'selected' : ''}>${c}</option>`).join('')}
                                </select>
                                <input type="date" id="log-from-date" onchange="state.logFromDate=this.value;state.logQuickFilter='';debouncedRenderLogs()" value="${state.logFromDate}" class="p-3.5 bg-slate-800/80 border border-slate-600 rounded-xl shadow-lg outline-none focus:ring-2 focus:ring-indigo-500 font-semibold text-slate-200 cursor-pointer hover:bg-slate-700 transition-transform w-full" placeholder="From">
                                <input type="date" id="log-to-date" onchange="state.logToDate=this.value;state.logQuickFilter='';debouncedRenderLogs()" value="${state.logToDate}" class="p-3.5 bg-slate-800/80 border border-slate-600 rounded-xl shadow-lg outline-none focus:ring-2 focus:ring-indigo-500 font-semibold text-slate-200 cursor-pointer hover:bg-slate-700 transition-transform w-full" placeholder="To">
                            </div>
                            <button onclick="exportToCSV('logs')" class="bg-green-600 hover:bg-green-500 text-white px-6 py-3.5 rounded-xl font-bold shadow-lg shadow-green-500/30 transition-transform hover-shine whitespace-nowrap">Export</button>
                        </div>
                    </div>
                    <div id="logs-list" class="space-y-3 fade-in"></div>
                </div>
            `;
            renderLogsList();
        }

        // Quick filter functions
        function setQuickLogFilter(filter) {
            state.logQuickFilter = filter;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            switch (filter) {
                case 'today':
                    state.logFromDate = today.toISOString().split('T')[0];
                    state.logToDate = today.toISOString().split('T')[0];
                    break;
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(today.getDate() - 7);
                    state.logFromDate = weekAgo.toISOString().split('T')[0];
                    state.logToDate = today.toISOString().split('T')[0];
                    break;
                case 'month':
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(today.getMonth() - 1);
                    state.logFromDate = monthAgo.toISOString().split('T')[0];
                    state.logToDate = today.toISOString().split('T')[0];
                    break;
                default:
                    state.logFromDate = '';
                    state.logToDate = '';
            }
            renderLogs(document.getElementById('content-container'));
        }

        function clearLogFilters() {
            state.logSearchTerm = '';
            state.logFilterType = 'All';
            state.logFilterCategory = 'All';
            state.logFromDate = '';
            state.logToDate = '';
            state.logQuickFilter = '';
            renderLogs(document.getElementById('content-container'));
        }
        function renderLogsList() {
            var logsContainer = document.getElementById('logs-list');
            if (!logsContainer) return;

            var filteredLogs = state.transactions.filter(t => {
                var tLower = state.logSearchTerm.toLowerCase();
                var date = new Date(t.created_at);
                var from = state.logFromDate ? new Date(state.logFromDate) : null;
                var to = state.logToDate ? new Date(state.logToDate) : null;
                // Fix for end date to include the whole day
                if (to) to.setHours(23, 59, 59, 999);

                return (state.logFilterType === 'All' || t.change_type === state.logFilterType) &&
                    (state.logFilterCategory === 'All' || (t.components && t.components.category === state.logFilterCategory)) &&
                    (t.reason && t.reason.toLowerCase().includes(tLower) || (t.components?.name && t.components.name.toLowerCase().includes(tLower)) || (t.components?.value && t.components.value.toLowerCase().includes(tLower))) &&
                    (!from || date >= from) && (!to || date <= to);
            });
            var logs = filteredLogs.length === 0 ? '<div class="text-center p-8 text-slate-500 bg-white/5 rounded-xl border border-white/10">No logs found.</div>' : filteredLogs.map(t => `
                <div class="bg-white text-slate-800 p-4 mb-3 rounded-xl shadow-sm border border-slate-100 flex items-center gap-4 hover:shadow-md transition-shadow hover-shine fade-in">
                     <div class="w-10 h-10 rounded-xl flex-shrink-0 flex items-center justify-center font-bold text-sm ${t.change_type === 'IN' ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}">
                        ${t.change_type}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between">
                            <div class="font-bold text-slate-700 truncate">${esc(t.components?.value || t.components?.name || 'Deleted Item')}</div>
                            <div class="font-mono font-bold text-slate-500">${t.change_type === 'IN' ? '+' : '-'}${t.quantity_changed}</div>
                        </div>
                        <div class="text-sm text-slate-500 truncate">Note: ${esc(t.reason)}</div>
                        <div class="text-xs text-slate-400 mt-1">${new Date(t.created_at).toLocaleString()}</div>
                    </div>
                </div>
            `).join('');
            logsContainer.innerHTML = logs;
        }
        function renderNotes(container) {
            // Priority colors
            const priorityColors = {
                'Urgent': 'bg-rose-100 text-rose-700 border-rose-300',
                'High': 'bg-orange-100 text-orange-700 border-orange-300',
                'Medium': 'bg-yellow-100 text-yellow-700 border-yellow-300',
                'Low': 'bg-emerald-100 text-emerald-700 border-emerald-300'
            };

            container.innerHTML = `
                <div class="max-w-3xl mx-auto pb-24">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                        <h2 class="text-2xl font-bold text-white">Shopping List / Notes</h2>
                        <div class="flex gap-3 w-full md:w-auto">
                            <select onchange="state.notesFilterPriority=this.value;renderNotes(document.getElementById('content-container'))" class="p-2 bg-slate-800/80 border border-slate-600 rounded-xl text-sm font-semibold text-slate-200">
                                <option value="All">All Priorities</option>
                                <option value="Urgent">Urgent</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                            <select onchange="state.notesFilterCompleted=this.value;renderNotes(document.getElementById('content-container'))" class="p-2 bg-slate-800/80 border border-slate-600 rounded-xl text-sm font-semibold text-slate-200">
                                <option value="All">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Completed">Completed</option>
                            </select>
                            <button onclick="openAddNoteModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-xl font-bold shadow-lg shadow-indigo-500/30 transition-transform hover-shine whitespace-nowrap">+ Add Note</button>
                        </div>
                    </div>
                    <div id="notes-list" class="space-y-4 fade-in"></div>
                </div>
            `;

            var notesContainer = document.getElementById('notes-list');

            // Filter notes
            var filteredNotes = state.notes.filter(n => {
                const priorityMatch = state.notesFilterPriority === 'All' || n.priority === state.notesFilterPriority;
                const completedMatch = state.notesFilterCompleted === 'All' ||
                    (state.notesFilterCompleted === 'Completed' && n.completed) ||
                    (state.notesFilterCompleted === 'Active' && !n.completed);
                return priorityMatch && completedMatch;
            });

            var notesHTML = filteredNotes.length === 0 ? '<div class="text-center p-8 text-slate-500 bg-white/5 rounded-xl border border-white/10">No notes found.</div>' : filteredNotes.map(n => {
                const priority = n.priority || 'Medium';
                const isOverdue = n.due_date && new Date(n.due_date) < new Date() && !n.completed;
                const tags = n.tags ? n.tags.split(',').map(t => t.trim()).filter(t => t) : [];

                return `
                <div class="bg-white text-slate-800 p-6 rounded-2xl shadow-lg border ${n.completed ? 'border-emerald-200 bg-emerald-50/30' : 'border-slate-100'} hover-shine transition-transform ${n.completed ? 'opacity-75' : ''}">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <input type="checkbox" ${n.completed ? 'checked' : ''} onchange="toggleNoteComplete(${n.id}, this.checked)" class="w-5 h-5 rounded border-2 border-slate-300 text-indigo-600 focus:ring-2 focus:ring-indigo-500 cursor-pointer">
                                <h3 class="font-bold text-xl ${n.completed ? 'line-through text-slate-500' : 'text-slate-900'}">${esc(n.title)}</h3>
                            </div>
                            <div class="flex flex-wrap gap-2 mt-2">
                                <span class="px-3 py-1 rounded-lg border font-bold text-xs ${priorityColors[priority]}">${priority}</span>
                                ${n.quantity ? `<span class="px-3 py-1 bg-indigo-50 text-indigo-700 rounded-lg border border-indigo-200 font-bold text-xs">Qty: ${n.quantity}</span>` : ''}
                                ${n.due_date ? `<span class="px-3 py-1 ${isOverdue ? 'bg-rose-100 text-rose-700 border-rose-300' : 'bg-blue-100 text-blue-700 border-blue-300'} rounded-lg border font-bold text-xs">${isOverdue ? '⚠️ ' : '📅 '}${new Date(n.due_date).toLocaleDateString()}</span>` : ''}
                                ${tags.map(tag => `<span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg border border-purple-200 font-semibold text-xs">#${esc(tag)}</span>`).join('')}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="shareNote(${n.id})" class="p-2 text-green-600 hover:bg-green-50 rounded-lg transition-transform hover-shine"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.026 12.553 7 11.223 7 9.5 7 7.567 8.567 6 10.5 6s3.5 1.567 3.5 3.5c0 1.723-1.026 3.053-1.684 3.842M10.5 6v.01M10.5 9.5v.01M10.5 13v.01M8.684 13.342l-2.342 2.342m0 0l-2.342 2.342m2.342-2.342H3m5.684 0h4.632m-2.326 2.326l2.342 2.342m0 0l2.342 2.342m-2.342-2.342H21"/></svg></button>
                            <button onclick="openEditNoteModal(${n.id})" class="p-2 text-slate-600 hover:bg-slate-50 rounded-lg transition-transform hover-shine"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></button>
                            <button onclick="deleteNote(${n.id})" class="p-2 text-rose-600 hover:bg-rose-50 rounded-lg transition-transform hover-shine"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>
                        </div>
                    </div>
                    <p class="text-slate-700 whitespace-pre-wrap ${n.completed ? 'line-through' : ''}">${esc(n.content)}</p>
                    <div class="text-xs text-slate-400 mt-4">Created: ${new Date(n.created_at).toLocaleString()}</div>
                </div>
            `}).join('');
            notesContainer.innerHTML = notesHTML;
        }

        // Toggle note completion
        function toggleNoteComplete(id, completed) {
            const note = state.notes.find(n => n.id === id);
            if (!note) return;

            fetch(state.dbConfig.url + '/rest/v1/notes?id=eq.' + id, {
                method: 'PATCH',
                headers: {
                    'apikey': state.dbConfig.key,
                    'Authorization': 'Bearer ' + state.dbConfig.key,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ completed: completed })
            }).then(r => r.json()).then(() => {
                note.completed = completed;
                showToast(completed ? 'Note marked as completed' : 'Note marked as active', 'success');
                renderNotes(document.getElementById('content-container'));
            }).catch(e => {
                console.error(e);
                showToast('Failed to update note', 'error');
            });
        }
        // ==========================================
        // 9. MODALS (AUTOFOCUS FIX, SMOOTH SCALE-IN)
        // ==========================================
        function openAddModal() { resetForm(); state.showAddModal = true; renderModals(); }
        function openEditModal(id) {
            var c = state.components.find(x => x.id === id);
            state.formData = { name: c.name, category: c.category, value: c.value || '', quantity: c.quantity, location: c.location || '', notes: c.notes || '', cost: c.cost_per_unit || '', minStock: c.min_stock_level || 5, datasheet: c.datasheet_url || '', purchasedDate: c.purchased_date || '', partNumber: c.part_number || '', supplierUrl: c.supplier_url || '', image: null, imageUrl: c.image_url || '' };
            state.editingId = c.id; state.showAddModal = true; renderModals();
        }
        function openStockModal(id, type, name) {
            state.stockAction = { id, type, name };
            state.showStockModal = true;
            renderModals();
            setTimeout(() => document.getElementById('stockQty').focus(), 100);
        }
        function openHistoryModal(id, name) {
            state.historyComponent = { id, name };
            state.showHistoryModal = true;
            renderModals();
        }
        function openAddNoteModal() { resetNoteForm(); state.showAddNoteModal = true; renderModals(); }
        function openEditNoteModal(id) {
            var n = state.notes.find(x => x.id === id);
            state.noteForm = {
                title: n.title,
                content: n.content,
                quantity: n.quantity || '',
                priority: n.priority || 'Medium',
                tags: n.tags || '',
                dueDate: n.due_date || '',
                completed: n.completed || false
            };
            state.editingNoteId = id; state.showAddNoteModal = true; renderModals();
        }
        function renderModals() {
            var container = document.getElementById('modals-container');
            if (!container) return;
            var html = '';
            if (state.showAddModal) {
                // AUTOFOCUS LOGIC with scroll handling
                setTimeout(() => {
                    var el = document.getElementById('compName');
                    if (el) {
                        el.focus();
                        // Scroll to input on mobile when keyboard opens
                        if (state.isMobile) {
                            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                }, 50);
                var catOpts = categories.map(c => `<option value="${c}" ${state.formData.category === c ? 'selected' : ''}>${c}</option>`).join('');
                html += `
                <div class="fixed inset-0 z-[100] flex items-end md:items-center justify-center bg-slate-900/60 backdrop-blur-sm scale-in" onclick="if(event.target===this){state.showAddModal=false;renderModals()}">
                    <div class="fixed-modal bg-white w-full md:w-[600px] md:rounded-2xl rounded-t-2xl max-h-[90vh] overflow-y-auto shadow-2xl scale-in text-slate-800">
                        <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                            <h2 class="text-xl font-bold text-slate-800">${state.editingId ? 'Edit' : 'Add'} Component</h2>
                            <button onclick="state.showAddModal=false;renderModals()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center font-bold transition-transform hover-shine">&times;</button>
                        </div>
                        <div class="p-6 space-y-5">
                            <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Name</label>
                            <input type="text" id="compName" list="tech-suggestions" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500 transition-transform" value="${esc(state.formData.name)}" oninput="state.formData.name=this.value" placeholder="e.g. ESP32" onfocus="if(window.innerWidth<768)this.scrollIntoView({behavior:'smooth',block:'center'})"></div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Category</label><input type="text" list="category-suggestions" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 font-medium outline-none" value="${esc(state.formData.category)}" oninput="state.formData.category=this.value" placeholder="Search..."></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Value / Spec</label><input type="text" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none" value="${esc(state.formData.value)}" oninput="state.formData.value=this.value"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Part Number</label><input type="text" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none" value="${esc(state.formData.partNumber)}" oninput="state.formData.partNumber=this.value"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Date Purchased</label><input type="date" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none" value="${esc(state.formData.purchasedDate)}" oninput="state.formData.purchasedDate=this.value"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Quantity</label><input type="number" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 font-mono font-bold text-lg outline-none" value="${esc(state.formData.quantity)}" oninput="state.formData.quantity=this.value"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Cost (₹)</label><input type="number" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none" value="${esc(state.formData.cost)}" oninput="state.formData.cost=this.value"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Location</label><input type="text" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none" value="${esc(state.formData.location)}" oninput="state.formData.location=this.value"></div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Min Stock</label><input type="number" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none" value="${esc(state.formData.minStock)}" oninput="state.formData.minStock=this.value"></div>
                            </div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Datasheet URL</label><input type="text" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none text-blue-600 placeholder:text-slate-400" value="${esc(state.formData.datasheet)}" oninput="state.formData.datasheet=this.value" placeholder="https://..."></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Supplier URL</label><input type="text" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none text-blue-600 placeholder:text-slate-400" value="${esc(state.formData.supplierUrl)}" oninput="state.formData.supplierUrl=this.value" placeholder="https://..."></div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Pinout Image</label>
                                <input type="file" accept="image/*" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none" onchange="state.formData.image=this.files[0]">
                                ${state.formData.imageUrl ? `<img src="${state.formData.imageUrl}" alt="Pinout" class="mt-2 max-h-40 rounded-xl">` : ''}
                            </div>
                            <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Notes</label><textarea class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none" oninput="state.formData.notes=this.value">${esc(state.formData.notes)}</textarea></div>
                            <div class="pt-4">
                                <button onclick="${state.editingId ? 'saveComponent(\'PATCH\', state.editingId)' : 'saveComponent()'}" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-500/30 hover:bg-indigo-500 transition transform active:scale-[0.98] hover-shine">Save Item</button>
                                ${state.editingId ? `<button onclick="deleteComponent(${state.editingId})" class="w-full text-rose-500 py-3 font-bold mt-2 hover:bg-rose-50 rounded-xl transition hover-shine">Delete Permanently</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            }
            // Move datalist rendering to global scope / ensure it's not nested in fixed
            if (!document.getElementById('category-suggestions')) {
                var dl = document.createElement('datalist');
                dl.id = 'category-suggestions';
                dl.innerHTML = categories.map(c => `<option value="${c}">`).join('');
                document.body.appendChild(dl);
            }
            if (state.showStockModal) {
                var isOut = state.stockAction.type === 'OUT';
                html += `
                <div class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm px-4 scale-in">
                    <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl text-center relative overflow-hidden scale-in text-slate-800">
                        <div class="absolute top-0 left-0 w-full h-1.5 ${isOut ? 'bg-rose-500' : 'bg-emerald-500'}"></div>
                        <h3 class="text-xl font-bold text-slate-800 mt-2 mb-1">${isOut ? 'Remove' : 'Add'} Stock</h3>
                        <p class="text-sm text-slate-500 mb-6 font-medium truncate px-2">${esc(state.stockAction.name)}</p>
                        <div class="flex items-center justify-center gap-4 mb-6">
                            <button onclick="document.getElementById('stockQty').stepDown()" class="w-12 h-12 bg-slate-100 rounded-full font-bold text-xl text-slate-600 hover:bg-slate-200 transition hover-shine">-</button>
                            <input type="number" id="stockQty" class="w-20 text-center text-4xl font-black text-slate-800 outline-none bg-transparent" value="1" min="1" step="1">
                            <button onclick="document.getElementById('stockQty').stepUp()" class="w-12 h-12 bg-slate-100 rounded-full font-bold text-xl text-slate-600 hover:bg-slate-200 transition hover-shine">+</button>
                        </div>
                        <input type="text" id="stockReason" class="w-full p-3.5 bg-slate-50 rounded-xl text-sm mb-6 border border-slate-200 font-medium focus:ring-2 focus:ring-indigo-500 outline-none transition text-slate-800" placeholder="${isOut ? 'Reason (e.g. Project X)' : 'Source (e.g. Amazon)'}">
                        <div class="flex gap-3">
                            <button onclick="state.showStockModal=false;renderModals()" class="flex-1 py-3 font-bold text-slate-500 bg-slate-100 rounded-xl hover:bg-slate-200 transition hover-shine">Cancel</button>
                            <button onclick="confirmStockUpdate()" class="flex-1 py-3 font-bold text-white rounded-xl shadow-lg ${isOut ? 'bg-rose-600 hover:bg-rose-700' : 'bg-emerald-600 hover:bg-emerald-700'} transition hover-shine">Confirm</button>
                        </div>
                    </div>
                </div>`;
            }
            if (state.showHistoryModal) {
                var filteredHistory = state.transactions.filter(t => t.component_id === state.historyComponent.id);
                var historyLogs = filteredHistory.length === 0 ? '<div class="text-center p-4 text-slate-500">No history for this component.</div>' : filteredHistory.map(t => `
                    <div class="bg-slate-50 p-3 rounded-xl mb-2 flex justify-between items-center">
                        <div>
                            <span class="font-bold ${t.change_type === 'IN' ? 'text-emerald-600' : 'text-rose-600'}">${t.change_type === 'IN' ? '+' : '-'}${t.quantity_changed}</span>
                            <span class="text-sm text-slate-500 ml-2">${esc(t.reason)}</span>
                        </div>
                        <div class="text-xs text-slate-400">${new Date(t.created_at).toLocaleString()}</div>
                    </div>
                `).join('');
                html += `
                <div class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm px-4 scale-in">
                    <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl relative overflow-hidden scale-in text-slate-800">
                        <div class="absolute top-0 left-0 w-full h-1.5 bg-yellow-500"></div>
                        <h3 class="text-xl font-bold text-slate-800 mb-4">${esc(state.historyComponent.name)} History</h3>
                        <div class="max-h-80 overflow-y-auto space-y-2 pr-2">${historyLogs}</div>
                        <button onclick="state.showHistoryModal=false;renderModals()" class="w-full py-3 font-bold text-white bg-indigo-600 rounded-xl hover:bg-indigo-500 transition hover-shine mt-6">Close</button>
                    </div>
                </div>`;
            }
            if (state.showAddNoteModal) {
                html += `
                <div class="fixed inset-0 z-50 flex items-end md:items-center justify-center bg-slate-900/60 backdrop-blur-sm scale-in" onclick="if(event.target===this){state.showAddNoteModal=false;renderModals()}">
                    <div class="fixed-modal bg-white w-full md:w-[600px] md:rounded-2xl rounded-t-2xl max-h-[85vh] overflow-y-auto shadow-2xl scale-in text-slate-800">
                        <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                            <h2 class="text-xl font-bold text-slate-800">${state.editingNoteId ? 'Edit' : 'Add'} Note</h2>
                            <button onclick="state.showAddNoteModal=false;renderModals()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center font-bold transition-transform hover-shine">&times;</button>
                        </div>
                        <div class="p-6 space-y-4">
                            <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Title</label><input type="text" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none focus:ring-2 focus:ring-indigo-500" value="${esc(state.noteForm.title)}" oninput="state.noteForm.title=this.value" placeholder="e.g. Next Purchase List"></div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Priority</label>
                                    <select class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none focus:ring-2 focus:ring-indigo-500" onchange="state.noteForm.priority=this.value">
                                        <option value="Low" ${state.noteForm.priority === 'Low' ? 'selected' : ''}>Low</option>
                                        <option value="Medium" ${state.noteForm.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                        <option value="High" ${state.noteForm.priority === 'High' ? 'selected' : ''}>High</option>
                                        <option value="Urgent" ${state.noteForm.priority === 'Urgent' ? 'selected' : ''}>Urgent</option>
                                    </select>
                                </div>
                                <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Quantity</label><input type="number" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none focus:ring-2 focus:ring-indigo-500" value="${esc(state.noteForm.quantity)}" oninput="state.noteForm.quantity=this.value" placeholder="Optional"></div>
                            </div>
                            
                            <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Tags <span class="text-slate-400 normal-case font-normal">(comma-separated)</span></label><input type="text" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none focus:ring-2 focus:ring-indigo-500" value="${esc(state.noteForm.tags)}" oninput="state.noteForm.tags=this.value" placeholder="e.g. electronics, urgent, shopping"></div>
                            
                            <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Due Date</label><input type="date" class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none focus:ring-2 focus:ring-indigo-500" value="${esc(state.noteForm.dueDate)}" oninput="state.noteForm.dueDate=this.value"></div>
                            
                            <div><label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Content</label><textarea class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl mt-1 outline-none focus:ring-2 focus:ring-indigo-500 h-32" oninput="state.noteForm.content=this.value">${esc(state.noteForm.content)}</textarea></div>
                            
                            <div class="pt-4">
                                <button onclick="${state.editingNoteId ? 'saveNote(\'PATCH\', state.editingNoteId)' : 'saveNote()'}" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-500/30 hover:bg-indigo-500 transition-transform transform active:scale-[0.98] hover-shine">Save Note</button>
                                ${state.editingNoteId ? `<button onclick="deleteNote(${state.editingNoteId})" class="w-full text-rose-500 py-3 font-bold mt-2 hover:bg-rose-50 rounded-xl transition-transform hover-shine">Delete Note</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            }
            if (state.showSetupModal) {
                var usedBytes = JSON.stringify(state.components).length;
                var usedKB = (usedBytes / 1024).toFixed(2);
                var imageUsedKB = (state.imageStorageUsed / 1024).toFixed(2);
                html += `
                <div class="fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/90 p-4 scale-in">
                    <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl text-center relative text-slate-800 scale-in overflow-y-auto max-h-[85vh]">
                        <button onclick="state.showSetupModal=false;renderModals()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600 text-xl font-bold hover-shine">&times;</button>
                        <div class="flex justify-center mb-4"><div class="w-16 h-16 bg-gradient-to-br from-slate-700 to-slate-900 rounded-full flex items-center justify-center text-3xl shadow-lg animate-spin-slow">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                        </div></div>
                        <h2 class="text-xl font-bold mb-1 text-slate-800">Settings & Security</h2>
                        <p class="text-xs text-slate-400 mb-6 uppercase tracking-wider font-bold">Version 2.2.0</p>
                        
                        <div class="text-left mb-6 bg-slate-50 p-4 rounded-xl border border-slate-200">
                            <div class="flex justify-between items-center mb-2">
                                <div class="text-xs font-bold text-slate-400 uppercase">Database Usage</div>
                                <div class="text-xs font-bold text-indigo-600">${usedKB} KB</div>
                            </div>
                            <div class="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden">
                                <div class="bg-indigo-500 h-full rounded-full" style="width: ${Math.min((usedBytes / 500000) * 100, 100)}%"></div>
                            </div>
                        </div>

                        <div class="space-y-4 text-left">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-slate-800">Connection Credentials</h3>
                                <button onclick="toggleCredentials()" class="text-xs font-bold px-2 py-1 rounded bg-slate-100 text-slate-600 hover:bg-slate-200 transition">
                                    ${state.credentialsLocked ? '🔒 Unlock to View' : '🔓 Lock Credentials'}
                                </button>
                            </div>
                            
                            ${state.credentialsLocked ? `
                                <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 text-center">
                                    <div class="text-4xl mb-2">🔒</div>
                                    <p class="text-sm text-slate-500 font-medium mb-4">Credentials are secured</p>
                                    <button onclick="unlockCredentials()" class="bg-slate-800 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-slate-700 transition shadow-lg w-full">Enter Password to Unlock</button>
                                </div>
                            ` : `
                                <div class="fade-in space-y-3">
                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase ml-1">Supabase URL</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-3 text-lg">🔗</span>
                                            <input type="text" class="w-full pl-10 p-3 border rounded-lg outline-none focus:border-indigo-500 transition font-mono text-sm" placeholder="https://xyz.supabase.co" value="${esc(state.dbConfig.url)}" oninput="state.dbConfig.url=this.value">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs font-bold text-slate-500 uppercase ml-1">Anon API Key</label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-3 text-lg">🔑</span>
                                            <input type="${state.showCredentials ? 'text' : 'password'}" class="w-full pl-10 pr-10 p-3 border rounded-lg outline-none focus:border-indigo-500 transition font-mono text-sm" placeholder="eyJ..." value="${esc(state.dbConfig.key)}" oninput="state.dbConfig.key=this.value">
                                            <button onclick="state.showCredentials=!state.showCredentials;renderModals()" class="absolute right-3 top-3 text-slate-400 hover:text-slate-600">
                                                ${state.showCredentials ? '👁️' : '👁️‍🗨️'}
                                            </button>
                                        </div>
                                    </div>
                                    <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-200 text-xs text-yellow-700">
                                        <strong>⚠️ Security Note:</strong> API keys are encrypted in local storage. Never share your Anon Key properly.
                                    </div>
                                </div>
                            `}
                        </div>

                        ${!state.credentialsLocked ? `
                            <button onclick="saveDbConfig()" class="w-full bg-indigo-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-indigo-500 transition mt-6 hover-shine">Save & Encrypt</button>
                        ` : ''}
                        
                        <div class="border-t border-slate-100 mt-6 pt-6">
                            <button onclick="state.showSetupModal=false;state.showStorageViewer=true;loadImages();renderModals()" class="w-full bg-blue-50 text-blue-600 py-3 rounded-xl font-bold hover:bg-blue-100 transition hover-shine">View Image Storage (${imageUsedKB} KB)</button>
                        </div>
                    </div>
                </div>`;
            }

            // Password Modal for Unlocking Credentials
            if (state.showPasswordModal) {
                html += `
                <div class="fixed inset-0 z-[200] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm px-4 scale-in">
                    <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl text-center relative overflow-hidden scale-in text-slate-800">
                        <div class="absolute top-0 left-0 w-full h-1.5 bg-indigo-500"></div>
                        <div class="text-5xl mb-3">🔐</div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">Enter Password</h3>
                        <p class="text-sm text-slate-500 mb-6">Enter application password to unlock credentials</p>
                        <input type="password" id="unlockPassword" class="w-full p-3.5 bg-slate-50 rounded-xl text-sm mb-6 border border-slate-200 font-medium focus:ring-2 focus:ring-indigo-500 outline-none transition text-slate-800 text-center" placeholder="Password" autofocus>
                        <div class="flex gap-3">
                            <button onclick="state.showPasswordModal=false;renderModals()" class="flex-1 py-3 font-bold text-slate-500 bg-slate-100 rounded-xl hover:bg-slate-200 transition hover-shine">Cancel</button>
                            <button onclick="verifyPasswordAndUnlock(document.getElementById('unlockPassword').value)" class="flex-1 py-3 font-bold text-white rounded-xl shadow-lg bg-indigo-600 hover:bg-indigo-700 transition hover-shine">Unlock</button>
                        </div>
                    </div>
                </div>`;
            }

            if (state.showStorageViewer) {
                var imagesHTML = state.images.length === 0
                    ? '<div class="text-center p-8 text-slate-500 font-medium">No images uploaded yet.</div>'
                    : state.images.map(img => `
                        <div class="bg-slate-50 p-4 rounded-xl flex items-center gap-3 hover:bg-slate-100 transition">
                            <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 font-bold flex-shrink-0">
                                📷
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-slate-800 font-medium truncate">${esc(img.name)}</div>
                                ${img.metadata && img.metadata.size ? `<div class="text-xs text-slate-400 mt-0.5">${(img.metadata.size / 1024).toFixed(2)} KB</div>` : ''}
                            </div>
                            <a href="${state.dbConfig.url + '/storage/v1/object/public/components/' + img.name}" target="_blank" class="text-blue-600 hover:underline font-bold text-sm flex-shrink-0">View</a>
                        </div>
                    `).join('');
                html += `
                <div class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/80 backdrop-blur-sm px-4 scale-in">
                    <div class="bg-white w-full max-w-md rounded-3xl p-6 shadow-2xl relative overflow-hidden scale-in text-slate-800">
                        <div class="absolute top-0 left-0 w-full h-1.5 bg-blue-500"></div>
                        <h3 class="text-xl font-bold text-slate-800 mb-4">Image Storage Viewer</h3>
                        <div class="max-h-96 overflow-y-auto space-y-2 pr-2">${imagesHTML}</div>
                        <button onclick="state.showStorageViewer=false;renderModals()" class="w-full py-3 font-bold text-white bg-indigo-600 rounded-xl hover:bg-indigo-500 transition hover-shine mt-6">Close</button>
                    </div>
                </div>`;
            }
            container.innerHTML = html;
            var hasModal = state.showAddModal || state.showStockModal || state.showSetupModal || state.showHistoryModal || state.showAddNoteModal || state.showStorageViewer;
            if (hasModal) {
                state.scrollY = window.pageYOffset;
                document.body.classList.add('modal-open');
                document.body.style.top = `- ${state.scrollY} px`;
            } else {
                const scrollY = state.scrollY;
                document.body.classList.remove('modal-open');
                document.body.style.top = '';
                window.scrollTo(0, scrollY);
            }
        }
        // ==========================================
        // 10. HELPERS & ACTIONS
        // ==========================================
        function handleLogin() {
            const btn = document.getElementById('loginBtn');
            const text = document.getElementById('loginText');
            const spinner = document.getElementById('loginSpinner');

            // Show loading state
            if (btn) {
                btn.disabled = true;
                text.textContent = 'AUTHENTICATING';
                spinner.classList.remove('hidden');
            }

            // Simulate slight delay for better UX feedback
            setTimeout(() => {
                if (document.getElementById('password').value === APP_PASSWORD) {
                    state.isAuthenticated = true;
                    sessionStorage.setItem('auth', 'true');
                    if (state.dbConfig.url) loadData();
                    else {
                        state.showSetupModal = true;
                        renderApp();
                    }
                } else {
                    alert('Incorrect Password');
                    // Reset button state
                    if (btn) {
                        btn.disabled = false;
                        text.textContent = 'INITIALIZE';
                        spinner.classList.add('hidden');
                    }
                }
            }, 300);
        }
        function saveDbConfig() {
            var url = state.dbConfig.url.replace(/\/$/, "");
            var key = state.dbConfig.key;
            if (!url || !key) { showToast('Please enter both URL and Key', 'warning'); return; }

            // Encrypt and save to localStorage
            localStorage.setItem('sb_url', encryptData(url, APP_PASSWORD));
            localStorage.setItem('sb_key', encryptData(key, APP_PASSWORD));

            // Update state
            state.dbConfig = { url: url, key: key };
            state.showSetupModal = false;

            showToast('Settings saved & encrypted', 'success');
            loadData();
        }
        function resetForm() {
            state.formData = { name: '', category: 'Microcontroller', value: '', quantity: '', location: '', notes: '', cost: '', minStock: '5', datasheet: '', purchasedDate: '', partNumber: '', supplierUrl: '', image: null, imageUrl: '' };
            state.editingId = null;
        }
        function resetNoteForm() {
            state.noteForm = { title: '', content: '', quantity: '' };
            state.editingNoteId = null;
        }
        function esc(t) { return t ? t.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ''; }
        function switchTab(tab) { state.activeTab = tab; renderHeader(); renderContent(); }
        function handleSearch(val) { state.searchTerm = val.toLowerCase(); updateList(); }
        function handleSort(val) { state.sortBy = val; updateList(); }
        const debouncedLogSearch = debounce((val) => {
            state.logSearchTerm = val;
            renderLogsList();
        }, 300);
        const debouncedRenderLogs = debounce(() => {
            renderLogs(document.getElementById('content-container'));
        }, 300);
        function exportToCSV(type) {
            let csvContent = "data:text/csv;charset=utf-8,";
            if (type === 'inventory') {
                csvContent += "ID,Name,Category,Value,Quantity,Location,Notes,Cost Per Unit,Min Stock,Datasheet URL,Purchased Date,Part Number,Supplier URL,Image URL\r\n";
                state.components.forEach(c => {
                    csvContent += `${c.id}, "${esc(c.name)}", "${esc(c.category)}", "${esc(c.value)}", ${c.quantity}, "${esc(c.location)}", "${esc(c.notes)}", ${c.cost_per_unit},${c.min_stock_level}, "${esc(c.datasheet_url)}", "${esc(c.purchased_date)}", "${esc(c.part_number)}", "${esc(c.supplier_url)}", "${esc(c.image_url)}"\r\n`;
                });
            } else if (type === 'logs') {
                csvContent += "ID,Component Name,Value,Change Type,Quantity Changed,Reason,Created At\r\n";
                state.transactions.forEach(t => {
                    csvContent += `${t.id}, "${esc(t.components ? t.components.name : 'Deleted Item')}", "${esc(t.components ? t.components.value : '')}", ${t.change_type},${t.quantity_changed}, "${esc(t.reason)}", "${t.created_at}"\r\n`;
                });
            }
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${type}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        // ==========================================
        // 11. CRUD LOGIC (WITH LOGS & SAFETY)
        // ==========================================
        async function saveComponent(method, id) {
            method = method || 'POST';
            var cost = parseFloat(state.formData.cost) || 0;
            var min = parseInt(state.formData.minStock) || 5;
            var comp = {
                name: state.formData.name, category: state.formData.category, value: state.formData.value,
                quantity: parseInt(state.formData.quantity), location: state.formData.location, notes: state.formData.notes,
                cost_per_unit: cost, min_stock_level: min, datasheet_url: state.formData.datasheet,
                purchased_date: state.formData.purchasedDate || null, part_number: state.formData.partNumber, supplier_url: state.formData.supplierUrl
            };
            if (method === 'POST') comp.date_added = new Date().toISOString();
            var url = method === 'PATCH' ? state.dbConfig.url + '/rest/v1/components?id=eq.' + id : state.dbConfig.url + '/rest/v1/components';
            var imageUrl = state.formData.imageUrl;
            if (state.formData.image) {
                const fileName = `${Date.now()}_${state.formData.image.name} `;
                const uploadRes = await fetch(state.dbConfig.url + '/storage/v1/object/components/' + fileName, {
                    method: 'POST', headers: { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key },
                    body: state.formData.image
                });
                if (uploadRes.ok) {
                    const uploadData = await uploadRes.json();
                    imageUrl = state.dbConfig.url + '/storage/v1/object/public/components/' + fileName;
                } else {
                    alert('Image upload failed.');
                    return;
                }
            }
            comp.image_url = imageUrl;
            fetch(url, {
                method: method, headers: { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                body: JSON.stringify(comp)
            }).then(r => r.json()).then(data => {
                if (method === 'POST') {
                    fetch(state.dbConfig.url + '/rest/v1/transactions', {
                        method: 'POST', headers: { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ component_id: data[0].id, change_type: 'IN', quantity_changed: comp.quantity, reason: 'Initial Add' })
                    });
                }
                state.showAddModal = false;
                resetForm();
                loadData();
            });
        }
        function deleteComponent(id) {
            if (!confirm('Permanently delete this item?')) return;
            var comp = state.components.find(c => c.id === id);
            if (comp) {
                fetch(state.dbConfig.url + '/rest/v1/transactions', {
                    method: 'POST', headers: { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ component_id: null, change_type: 'OUT', quantity_changed: 0, reason: `DELETED: ${comp.name} ` })
                });
            }
            fetch(state.dbConfig.url + '/rest/v1/components?id=eq.' + id, {
                method: 'DELETE', headers: { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key }
            }).then(() => { state.showAddModal = false; loadData(); });
        }
        function confirmStockUpdate() {
            var qty = parseInt(document.getElementById('stockQty').value) || 0;
            var reason = document.getElementById('stockReason').value;

            if (qty <= 0) return alert("Quantity must be > 0");

            var comp = state.components.find(c => c.id === state.stockAction.id);

            if (state.stockAction.type === 'OUT') {
                if (!reason) reason = "Project Use";
                if (comp.quantity - qty < 0) {
                    alert("Error: Insufficient stock to remove " + qty + " items.");
                    return;
                }
            } else {
                if (!reason) reason = "Restock";
            }
            var newQty = state.stockAction.type === 'IN' ? comp.quantity + qty : comp.quantity - qty;
            state.showStockModal = false; renderModals();

            fetch(state.dbConfig.url + '/rest/v1/components?id=eq.' + state.stockAction.id, {
                method: 'PATCH',
                headers: { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key, 'Content-Type': 'application/json' },
                body: JSON.stringify({ quantity: newQty })
            }).then(() => {
                var log = { component_id: state.stockAction.id, change_type: state.stockAction.type, quantity_changed: qty, reason: reason };
                return fetch(state.dbConfig.url + '/rest/v1/transactions', {
                    method: 'POST', headers: { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key, 'Content-Type': 'application/json' }, body: JSON.stringify(log)
                });
            }).then(() => loadData());
        }
        function saveNote(method, id) {
            method = method || 'POST';
            var note = { title: state.noteForm.title, content: state.noteForm.content, quantity: parseInt(state.noteForm.quantity) || null };
            var url = method === 'PATCH' ? state.dbConfig.url + '/rest/v1/notes?id=eq.' + id : state.dbConfig.url + '/rest/v1/notes';
            fetch(url, {
                method: method, headers: { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key, 'Content-Type': 'application/json' },
                body: JSON.stringify(note)
            }).then(() => {
                state.showAddNoteModal = false;
                resetNoteForm();
                loadData();
            });
        }
        function deleteNote(id) {
            if (!confirm('Delete this note?')) return;
            fetch(state.dbConfig.url + '/rest/v1/notes?id=eq.' + id, {
                method: 'DELETE', headers: { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key }
            }).then(() => { state.showAddNoteModal = false; loadData(); });
        }
        function shareNote(id) {
            var n = state.notes.find(x => x.id === id);
            if (navigator.share) {
                navigator.share({
                    title: n.title,
                    text: `${n.title} \n\n${n.content}`
                }).catch(console.error);
            } else {
                alert('Sharing not supported on this device.');
            }
        }
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
