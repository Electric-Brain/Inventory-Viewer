<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventory Master V11.0 Pro</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* --- THEME CONFIG --- */
        :root {
            --primary: #6366f1;
            --surface: #0f172a;
            --glass: rgba(30, 41, 59, 0.7);
            --border: rgba(255, 255, 255, 0.1);
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: var(--surface);
            color: #e2e8f0;
            overflow-x: hidden;
        }

        /* --- BACKGROUND MESH --- */
        #fixed-bg {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -50;
            background: 
                radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.15), transparent 25%), 
                radial-gradient(circle at 85% 30%, rgba(168, 85, 247, 0.15), transparent 25%);
            background-color: #020617;
        }
        
        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        
        .animate-enter { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .animate-pop { animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        /* Staggered Animation for Rows */
        tr.animate-enter:nth-child(1) { animation-delay: 0.05s; }
        tr.animate-enter:nth-child(2) { animation-delay: 0.1s; }
        tr.animate-enter:nth-child(3) { animation-delay: 0.15s; }
        tr.animate-enter:nth-child(4) { animation-delay: 0.2s; }
        tr.animate-enter:nth-child(5) { animation-delay: 0.25s; }

        /* --- UI COMPONENTS --- */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Moving Border Shine Effect */
        .shine-border {
            position: relative;
            overflow: hidden;
        }
        .shine-border::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: skewX(-25deg);
            animation: shine 6s infinite;
        }
        @keyframes shine { 
            0% { left: -100%; } 
            20% { left: 200%; } 
            100% { left: 200%; } 
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* --- RESPONSIVE UTILS --- */
        .desktop-table { display: none; }
        .mobile-cards { display: block; }

        @media (min-width: 1024px) {
            .desktop-table { display: table; }
            .mobile-cards { display: none; }
            
            /* The Big Headers You Requested */
            th.big-header {
                font-size: 1.1rem;
                font-weight: 800;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                background: linear-gradient(180deg, #1e1b4b 0%, #0f172a 100%);
                color: #a5b4fc;
                padding: 1.5rem;
                border-bottom: 3px solid #6366f1;
            }
        }
    </style>
</head>

<body class="pb-20 lg:pb-0">
    <div id="fixed-bg"></div>
    <div id="app"></div>

    <datalist id="tech-suggestions">
        <option value="Arduino Uno"><option value="ESP32"><option value="Raspberry Pi 4"><option value="Resistor 10k"><option value="Capacitor 100uF"><option value="OLED Display"><option value="Stepper Motor">
    </datalist>

    <script>
        // ================= CONFIGURATION =================
        const APP_PASSWORD = 'IV9769806390D'; // Keep your password
        const CATEGORIES = ['Microcontroller', 'Sensor', 'Display', 'LED', 'Passive', 'Module', 'Motor', 'Power', 'Tool', 'Other'];
        
        // ================= STATE =================
        let state = {
            activeTab: 'inventory',
            components: [], 
            transactions: [],
            searchTerm: '', 
            filterCategory: 'All',
            isAuthenticated: false, 
            loading: false,
            // UI States
            showAdd: false, showSetup: false, showStock: false,
            // Edit/Action States
            editingId: null,
            stockAction: { id: null, type: 'IN', name: '' },
            // Config
            dbConfig: { url: '', key: '' },
            formData: resetFormObject()
        };

        // ================= INIT =================
        function init() {
            // Load Config
            const savedConfig = localStorage.getItem('dbConfig');
            if(savedConfig) state.dbConfig = JSON.parse(savedConfig);
            
            // Check Auth
            if(sessionStorage.getItem('auth') === 'true') {
                state.isAuthenticated = true;
                if(state.dbConfig.url) fetchData();
            }
            render();
        }

        // ================= SUPABASE FETCH =================
        async function fetchData() {
            if(!state.dbConfig.url || !state.dbConfig.key) return;
            state.loading = true;
            render(); // Show loader

            const headers = { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key };
            
            try {
                const [comps, logs] = await Promise.all([
                    fetch(`${state.dbConfig.url}/rest/v1/components?select=*&order=name.asc`, { headers }).then(r => r.json()),
                    fetch(`${state.dbConfig.url}/rest/v1/transactions?select=*,components(name)&order=created_at.desc&limit=50`, { headers }).then(r => r.json())
                ]);
                
                state.components = Array.isArray(comps) ? comps : [];
                state.transactions = Array.isArray(logs) ? logs : [];
            } catch (e) {
                console.error("Fetch Error:", e);
                alert("Connection failed. Check settings.");
            } finally {
                state.loading = false;
                render();
            }
        }

        // ================= RENDER CORE =================
        function render() {
            const app = document.getElementById('app');
            
            if(!state.isAuthenticated) {
                app.innerHTML = renderLogin();
                return;
            }

            // Main Layout
            app.innerHTML = `
                <div class="min-h-screen flex flex-col">
                    ${renderHeader()}
                    
                    <main class="flex-1 max-w-7xl w-full mx-auto p-4 lg:p-8 animate-enter">
                        ${state.activeTab === 'inventory' ? renderControls() + renderInventory() : renderLogs()}
                    </main>

                    ${renderFloatingFab()}
                    ${renderModals()}
                </div>
            `;

            // Restore Focus Logic (Fixes Search Glitch)
            if(state.activeTab === 'inventory' && document.getElementById('search-input')) {
                const input = document.getElementById('search-input');
                input.value = state.searchTerm;
                input.focus(); 
            }
        }

        // ================= COMPONENT VIEWS =================
        
        function renderLogin() {
            return `
                <div class="min-h-screen flex items-center justify-center p-6">
                    <div class="glass-panel p-10 rounded-3xl w-full max-w-md text-center relative overflow-hidden animate-pop">
                        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
                        <h1 class="text-4xl font-black mb-2 tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400">Inventory<br>Master V11</h1>
                        <p class="text-slate-400 mb-8 font-mono text-sm">SECURE ACCESS REQUIRED</p>
                        <input type="password" id="login-pass" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl p-4 text-center text-white text-xl tracking-widest outline-none focus:border-indigo-500 transition-colors mb-4" placeholder="•••••••••" onkeypress="if(event.key==='Enter') doLogin()">
                        <button onclick="doLogin()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-indigo-500/25 transition-all transform hover:scale-[1.02]">AUTHENTICATE</button>
                    </div>
                </div>
            `;
        }

        function renderHeader() {
            const totalValue = state.components.reduce((acc, c) => acc + (c.quantity * (c.cost_per_unit||0)), 0);
            return `
                <header class="sticky top-0 z-40 glass-panel border-b-0 border-b-slate-700">
                    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap justify-between items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center font-bold text-xl shadow-lg">IM</div>
                            <div>
                                <h1 class="font-bold text-lg leading-none">Inventory Master</h1>
                                <div class="text-xs text-slate-400 font-mono">Value: ₹${totalValue.toLocaleString()}</div>
                            </div>
                        </div>

                        <div class="flex bg-slate-800/80 p-1 rounded-xl border border-slate-700">
                            <button onclick="setTab('inventory')" class="px-5 py-2 rounded-lg text-sm font-bold transition-all ${state.activeTab === 'inventory' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}">Items</button>
                            <button onclick="setTab('logs')" class="px-5 py-2 rounded-lg text-sm font-bold transition-all ${state.activeTab === 'logs' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}">History</button>
                        </div>

                        <button onclick="toggleModal('showSetup', true)" class="w-10 h-10 rounded-xl bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700 transition flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        </button>
                    </div>
                </header>
            `;
        }

        function renderControls() {
            return `
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <div class="relative flex-1">
                        <svg class="absolute left-4 top-3.5 w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                        <input type="text" id="search-input" 
                            class="w-full bg-slate-800/50 border border-slate-700 rounded-xl pl-12 pr-4 py-3 text-white placeholder-slate-500 focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all" 
                            placeholder="Search by name, spec, or location..."
                            oninput="handleSearch(this.value)"
                        >
                    </div>
                    <select onchange="state.filterCategory=this.value; render()" class="bg-slate-800/50 border border-slate-700 text-white rounded-xl px-4 py-3 outline-none focus:ring-2 focus:ring-indigo-500 cursor-pointer">
                        <option value="All">All Categories</option>
                        ${CATEGORIES.map(c => `<option value="${c}" ${state.filterCategory===c?'selected':''}>${c}</option>`).join('')}
                    </select>
                    <button onclick="openAddModal()" class="hidden lg:flex bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-indigo-500/20 transition-all items-center gap-2 transform hover:-translate-y-1">
                        <span>+ Add Component</span>
                    </button>
                </div>
            `;
        }

        function renderInventory() {
            // Filter Logic
            const filtered = state.components.filter(c => {
                const term = state.searchTerm.toLowerCase();
                const matchTerm = c.name.toLowerCase().includes(term) || (c.value||'').toLowerCase().includes(term) || (c.location||'').toLowerCase().includes(term);
                const matchCat = state.filterCategory === 'All' || c.category === state.filterCategory;
                return matchTerm && matchCat;
            });

            if(filtered.length === 0) return `<div class="text-center p-12 text-slate-500 bg-slate-800/30 rounded-2xl border border-dashed border-slate-700">No components found.</div>`;

            // 1. MOBILE CARDS VIEW
            const mobileCards = filtered.map(c => `
                <div class="glass-panel p-5 rounded-2xl mb-4 relative overflow-hidden animate-enter shine-border">
                    <div class="absolute left-0 top-0 bottom-0 w-1 ${c.quantity <= (c.min_stock_level||5) ? 'bg-rose-500' : 'bg-emerald-500'}"></div>
                    <div class="flex justify-between items-start mb-2 pl-3">
                        <div>
                            <h3 class="font-bold text-lg text-white leading-tight">${c.name}</h3>
                            <div class="text-xs font-bold text-indigo-400 uppercase tracking-wider mt-1">${c.category}</div>
                        </div>
                        <div class="text-3xl font-black text-white/90">${c.quantity}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-4 pl-3">
                        <div class="bg-slate-800/50 p-2 rounded-lg border border-slate-700">
                            <div class="text-[10px] text-slate-500 uppercase">Spec</div>
                            <div class="font-mono text-sm truncate">${c.value || '-'}</div>
                        </div>
                        <div class="bg-slate-800/50 p-2 rounded-lg border border-slate-700">
                            <div class="text-[10px] text-slate-500 uppercase">Loc</div>
                            <div class="font-mono text-sm truncate">${c.location || '-'}</div>
                        </div>
                    </div>
                    <div class="flex gap-2 pl-3">
                        <button onclick="openStock(${c.id}, 'OUT', '${c.name}')" class="flex-1 bg-rose-500/10 text-rose-500 border border-rose-500/20 py-2 rounded-lg font-bold hover:bg-rose-500/20 active:scale-95 transition">-</button>
                        <button onclick="openStock(${c.id}, 'IN', '${c.name}')" class="flex-1 bg-emerald-500/10 text-emerald-500 border border-emerald-500/20 py-2 rounded-lg font-bold hover:bg-emerald-500/20 active:scale-95 transition">+</button>
                        <button onclick="openEdit(${c.id})" class="px-4 bg-slate-700 text-slate-300 rounded-lg hover:bg-slate-600 transition"><i class="fas fa-edit"></i> Edit</button>
                    </div>
                </div>
            `).join('');

            // 2. PC TABLE VIEW (THE BIG HEADERS)
            const pcRows = filtered.map(c => `
                <tr class="animate-enter hover:bg-slate-800/50 transition-colors border-b border-slate-800 group">
                    <td class="p-4">
                        <div class="font-bold text-lg text-white">${c.name}</div>
                        <span class="text-xs bg-indigo-500/10 text-indigo-400 px-2 py-0.5 rounded border border-indigo-500/20 uppercase font-bold">${c.category}</span>
                    </td>
                    <td class="p-4 font-mono text-slate-300">${c.value || '<span class="text-slate-600">-</span>'}</td>
                    <td class="p-4 text-slate-300"><span class="bg-slate-800 px-2 py-1 rounded border border-slate-700">${c.location || '?'}</span></td>
                    <td class="p-4">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl font-black ${c.quantity <= (c.min_stock_level||5) ? 'text-rose-500' : 'text-emerald-400'}">${c.quantity}</div>
                            <div class="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onclick="openStock(${c.id}, 'IN', '${c.name}')" class="w-6 h-6 rounded bg-emerald-500/20 text-emerald-500 hover:bg-emerald-500 hover:text-white flex items-center justify-center text-xs">▲</button>
                                <button onclick="openStock(${c.id}, 'OUT', '${c.name}')" class="w-6 h-6 rounded bg-rose-500/20 text-rose-500 hover:bg-rose-500 hover:text-white flex items-center justify-center text-xs">▼</button>
                            </div>
                        </div>
                    </td>
                    <td class="p-4 text-right">
                        <button onclick="openEdit(${c.id})" class="text-slate-400 hover:text-indigo-400 font-bold text-sm bg-slate-800 hover:bg-slate-700 px-3 py-1.5 rounded-lg transition">Edit</button>
                    </td>
                </tr>
            `).join('');

            return `
                <div class="mobile-cards pb-24">${mobileCards}</div>
                <div class="desktop-table w-full rounded-2xl overflow-hidden glass-panel shadow-2xl">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr>
                                <th class="big-header w-1/3">Component</th>
                                <th class="big-header w-1/6">Specification</th>
                                <th class="big-header w-1/6">Storage</th>
                                <th class="big-header w-1/6">Current Stock</th>
                                <th class="big-header w-1/6 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-800/50">
                            ${pcRows}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function renderLogs() {
            if(state.transactions.length === 0) return `<div class="text-center p-8 text-slate-500">No history available.</div>`;
            return `
                <div class="max-w-4xl mx-auto space-y-3 pb-24">
                    ${state.transactions.map(t => `
                        <div class="glass-panel p-4 rounded-xl flex items-center gap-4 animate-enter hover:bg-slate-800/60 transition">
                            <div class="w-12 h-12 rounded-full flex items-center justify-center font-black text-lg shadow-inner ${t.change_type === 'IN' ? 'bg-emerald-500/10 text-emerald-500' : 'bg-rose-500/10 text-rose-500'}">
                                ${t.change_type === 'IN' ? '+' : '-'}
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-baseline">
                                    <h4 class="font-bold text-white text-lg">${t.components?.name || 'Deleted Item'}</h4>
                                    <span class="font-mono text-xl font-bold ${t.change_type === 'IN' ? 'text-emerald-400' : 'text-rose-400'}">${t.change_type === 'IN' ? '+' : '-'}${t.quantity_changed}</span>
                                </div>
                                <div class="flex justify-between items-center mt-1">
                                    <p class="text-sm text-slate-400">${t.reason || 'No specific reason'}</p>
                                    <span class="text-xs text-slate-600 font-mono">${new Date(t.created_at).toLocaleString()}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderFloatingFab() {
            return `
                <button onclick="openAddModal()" class="lg:hidden fixed bottom-6 right-6 w-16 h-16 bg-indigo-600 text-white rounded-full shadow-2xl shadow-indigo-600/40 flex items-center justify-center text-3xl z-40 active:scale-90 transition-transform">
                    <span class="relative -top-0.5">+</span>
                </button>
            `;
        }

        // ================= MODALS =================
        function renderModals() {
            let html = '';

            // ADD / EDIT MODAL
            if(state.showAdd) {
                html += `
                <div class="fixed inset-0 z-50 flex items-end lg:items-center justify-center bg-black/80 backdrop-blur-sm animate-enter" onclick="if(event.target===this) toggleModal('showAdd', false)">
                    <div class="bg-slate-900 w-full lg:w-[600px] lg:rounded-2xl rounded-t-2xl border border-slate-700 shadow-2xl p-6 lg:p-8 animate-slideInRight lg:animate-pop">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-black text-white">${state.editingId ? 'Edit' : 'New'} Component</h2>
                            <button onclick="toggleModal('showAdd', false)" class="text-slate-500 hover:text-white text-2xl">&times;</button>
                        </div>
                        <div class="space-y-4 max-h-[70vh] overflow-y-auto">
                            <div>
                                <label class="text-xs uppercase font-bold text-indigo-400">Component Name</label>
                                <input type="text" id="m-name" list="tech-suggestions" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 mt-1 text-white focus:border-indigo-500 outline-none font-bold" value="${state.formData.name}" oninput="state.formData.name=this.value">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs uppercase font-bold text-slate-500">Category</label>
                                <select class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 mt-1 text-white outline-none" onchange="state.formData.category=this.value">
                                    ${CATEGORIES.map(c => `<option ${state.formData.category===c?'selected':''}>${c}</option>`).join('')}
                                </select></div>
                                <div><label class="text-xs uppercase font-bold text-slate-500">Specification</label>
                                <input type="text" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 mt-1 text-white outline-none" value="${state.formData.value}" oninput="state.formData.value=this.value"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-xs uppercase font-bold text-slate-500">Initial Stock</label>
                                <input type="number" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 mt-1 text-white font-mono font-bold text-lg outline-none" value="${state.formData.quantity}" oninput="state.formData.quantity=this.value"></div>
                                <div><label class="text-xs uppercase font-bold text-slate-500">Storage Loc</label>
                                <input type="text" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 mt-1 text-white outline-none" value="${state.formData.location}" oninput="state.formData.location=this.value"></div>
                            </div>
                            <div>
                                <label class="text-xs uppercase font-bold text-slate-500">Cost Per Unit (₹)</label>
                                <input type="number" class="w-full bg-slate-800 border border-slate-700 rounded-xl p-3 mt-1 text-white outline-none" value="${state.formData.cost}" oninput="state.formData.cost=this.value">
                            </div>
                            <button onclick="saveItem()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl mt-4 shadow-lg active:scale-[0.98] transition">SAVE COMPONENT</button>
                            ${state.editingId ? `<button onclick="deleteItem()" class="w-full text-rose-500 font-bold py-2 hover:bg-rose-500/10 rounded-xl transition">Delete Permanently</button>` : ''}
                        </div>
                    </div>
                </div>`;
                // Autofocus hack
                setTimeout(() => document.getElementById('m-name')?.focus(), 50);
            }

            // STOCK MODAL
            if(state.showStock) {
                html += `
                <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-sm animate-enter">
                    <div class="bg-slate-900 w-80 rounded-3xl p-6 border border-slate-700 shadow-2xl text-center animate-pop relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-1.5 ${state.stockAction.type==='IN'?'bg-emerald-500':'bg-rose-500'}"></div>
                        <h3 class="text-xl font-bold text-white mb-1">${state.stockAction.type==='IN'?'Add':'Remove'} Stock</h3>
                        <p class="text-slate-400 text-sm mb-6">${state.stockAction.name}</p>
                        
                        <div class="flex items-center justify-center gap-4 mb-6">
                            <button onclick="document.getElementById('s-qty').stepDown()" class="w-10 h-10 rounded-full bg-slate-800 text-white font-bold hover:bg-slate-700">-</button>
                            <input type="number" id="s-qty" value="1" class="w-16 bg-transparent text-center text-3xl font-black text-white outline-none border-b border-slate-700 focus:border-indigo-500">
                            <button onclick="document.getElementById('s-qty').stepUp()" class="w-10 h-10 rounded-full bg-slate-800 text-white font-bold hover:bg-slate-700">+</button>
                        </div>
                        
                        <input type="text" id="s-reason" placeholder="Reason (Optional)" class="w-full bg-slate-800 rounded-xl p-3 text-sm text-white mb-4 outline-none border border-slate-700 focus:border-indigo-500">
                        
                        <div class="flex gap-2">
                            <button onclick="toggleModal('showStock', false)" class="flex-1 py-3 rounded-xl bg-slate-800 text-slate-400 font-bold hover:bg-slate-700">Cancel</button>
                            <button onclick="commitStock()" class="flex-1 py-3 rounded-xl font-bold text-white ${state.stockAction.type==='IN'?'bg-emerald-600 hover:bg-emerald-500':'bg-rose-600 hover:bg-rose-500'} shadow-lg">Confirm</button>
                        </div>
                    </div>
                </div>`;
                setTimeout(() => document.getElementById('s-qty')?.focus(), 50);
            }

            // SETUP MODAL
            if(state.showSetup) {
                html += `
                <div class="fixed inset-0 z-[70] flex items-center justify-center bg-black/95 backdrop-blur animate-enter">
                    <div class="bg-slate-900 w-full max-w-md rounded-2xl p-8 border border-slate-700 shadow-2xl animate-pop">
                        <h2 class="text-2xl font-bold text-white mb-6">System Settings</h2>
                        <div class="space-y-4 mb-6">
                            <div><label class="text-xs uppercase font-bold text-slate-500">Supabase URL</label>
                            <input type="text" id="conf-url" value="${state.dbConfig.url}" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-indigo-500"></div>
                            <div><label class="text-xs uppercase font-bold text-slate-500">Supabase Key</label>
                            <input type="text" id="conf-key" value="${state.dbConfig.key}" class="w-full bg-slate-800 border border-slate-700 p-3 rounded-xl text-white outline-none focus:border-indigo-500"></div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="exportCSV()" class="flex-1 bg-slate-800 hover:bg-slate-700 text-indigo-400 py-3 rounded-xl font-bold border border-slate-700">Export CSV</button>
                            <button onclick="saveConfig()" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-xl font-bold shadow-lg">Save & Connect</button>
                        </div>
                        <button onclick="toggleModal('showSetup', false)" class="w-full text-center text-slate-500 mt-4 text-sm hover:text-white">Close</button>
                    </div>
                </div>`;
            }

            return html;
        }

        // ================= ACTIONS =================
        function doLogin() {
            if(document.getElementById('login-pass').value === APP_PASSWORD) {
                sessionStorage.setItem('auth', 'true');
                state.isAuthenticated = true;
                init();
            } else alert("Access Denied");
        }

        function setTab(t) { state.activeTab = t; render(); }
        
        function handleSearch(val) {
            state.searchTerm = val;
            render(); // Logic is inside renderInventory()
        }

        function toggleModal(name, show) {
            state[name] = show;
            render();
        }

        function openAddModal() {
            state.formData = resetFormObject();
            state.editingId = null;
            toggleModal('showAdd', true);
        }

        function openEdit(id) {
            const c = state.components.find(x => x.id === id);
            state.formData = { 
                name: c.name, category: c.category, value: c.value||'', 
                quantity: c.quantity, location: c.location||'', cost: c.cost_per_unit||'', 
            };
            state.editingId = id;
            toggleModal('showAdd', true);
        }

        function openStock(id, type, name) {
            state.stockAction = { id, type, name };
            toggleModal('showStock', true);
        }

        // ================= DATA LOGIC =================
        async function saveItem() {
            const d = state.formData;
            const comp = {
                name: d.name, category: d.category, value: d.value, 
                quantity: parseInt(d.quantity)||0, location: d.location, 
                cost_per_unit: parseFloat(d.cost)||0
            };

            const url = state.editingId 
                ? `${state.dbConfig.url}/rest/v1/components?id=eq.${state.editingId}` 
                : `${state.dbConfig.url}/rest/v1/components`;
            
            const method = state.editingId ? 'PATCH' : 'POST';
            
            await apiCall(url, method, comp);
            
            // Log if new
            if(!state.editingId) {
                // Fetch ID logic omitted for brevity, usually you get response
                // For V11 simple version, we reload
            }
            
            toggleModal('showAdd', false);
            fetchData();
        }

        async function deleteItem() {
            if(!confirm("Are you sure?")) return;
            await apiCall(`${state.dbConfig.url}/rest/v1/components?id=eq.${state.editingId}`, 'DELETE');
            toggleModal('showAdd', false);
            fetchData();
        }

        async function commitStock() {
            const qty = parseInt(document.getElementById('s-qty').value);
            if(qty <= 0) return;
            
            const c = state.components.find(x => x.id === state.stockAction.id);
            const newQty = state.stockAction.type === 'IN' ? c.quantity + qty : c.quantity - qty;
            
            if(newQty < 0) return alert("Not enough stock!");

            // 1. Update Comp
            await apiCall(`${state.dbConfig.url}/rest/v1/components?id=eq.${c.id}`, 'PATCH', { quantity: newQty });
            
            // 2. Add Log
            const log = {
                component_id: c.id, change_type: state.stockAction.type, 
                quantity_changed: qty, reason: document.getElementById('s-reason').value
            };
            await apiCall(`${state.dbConfig.url}/rest/v1/transactions`, 'POST', log);
            
            toggleModal('showStock', false);
            fetchData();
        }

        async function apiCall(url, method, body) {
            await fetch(url, {
                method: method,
                headers: { 
                    'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key,
                    'Content-Type': 'application/json', 'Prefer': 'return=minimal'
                },
                body: body ? JSON.stringify(body) : null
            });
        }

        function saveConfig() {
            state.dbConfig = {
                url: document.getElementById('conf-url').value.replace(/\/$/, ""),
                key: document.getElementById('conf-key').value
            };
            localStorage.setItem('dbConfig', JSON.stringify(state.dbConfig));
            toggleModal('showSetup', false);
            fetchData();
        }
        
        function exportCSV() {
            let csv = "Name,Category,Spec,Location,Quantity,Cost\n";
            state.components.forEach(c => {
                csv += `${c.name},${c.category},${c.value},${c.location},${c.quantity},${c.cost_per_unit}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'inventory_export.csv';
            a.click();
        }

        function resetFormObject() {
            return { name: '', category: 'Microcontroller', value: '', quantity: '', location: '', cost: '' };
        }

        // Start
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
