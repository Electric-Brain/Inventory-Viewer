<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Inventory Master 2.1.0 - Advanced inventory management system">
    <title>Inventory Master 2.1.0</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* --- PERFORMANCE OPTIMIZATIONS --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html {
            overflow-y: scroll;
            -webkit-tap-highlight-color: transparent;
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }

        /* --- BACKGROUND FLICKER FIX --- */
        #fixed-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -50;
            background-color: #0f172a;
            background-image:
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.15), transparent 40%),
                radial-gradient(circle at 100% 100%, rgba(168, 85, 247, 0.15), transparent 40%);
            background-size: 30px 30px, 30px 30px, cover, cover;
        }

        /* --- ANIMATIONS --- */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes shine {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .slide-up {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .scale-in {
            animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .slide-in-right {
            animation: slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        .animate-pulse-slow {
            animation: pulse 2s infinite ease-in-out;
        }

        /* Gradient Title Animation */
        .animate-gradient-text {
            background: linear-gradient(270deg, #818cf8, #c084fc, #818cf8);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shine 4s ease infinite;
        }

        /* --- GLASS UI --- */
        .glass-header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* --- RESPONSIVE & FONT FIXES --- */
        .desktop-only {
            display: none !important;
        }

        .mobile-only {
            display: block !important;
        }

        /* PC Specific Scaling */
        @media (min-width: 1024px) {
            .desktop-only {
                display: block !important;
            }

            .mobile-only {
                display: none !important;
            }

            /* INCREASED FONT SIZE FOR PC */
            body {
                font-size: 16px;
            }

            td {
                font-size: 1rem !important;
            }
        }

        /* --- UTILS --- */
        .text-clamp {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .text-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Autofill Fix for Dark Theme */
        input:-webkit-autofill,
        input:-webkit-autofill:hover,
        input:-webkit-autofill:focus,
        input:-webkit-autofill:active {
            -webkit-box-shadow: 0 0 0 30px #1e293b inset !important;
            -webkit-text-fill-color: white !important;
            transition: background-color 5000s ease-in-out 0s;
        }

        /* Enhanced Hover Effects */
        .hover-shine {
            position: relative;
            overflow: hidden;
        }

        .hover-shine::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translate(50%, 50%);
            pointer-events: none;
        }

        .hover-shine:hover::before {
            opacity: 1;
            transform: translate(0, 0);
        }

        .hover-scale {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hover-scale:hover {
            transform: scale(1.05);
        }

        /* Smooth Transitions */
        .transition-all-smooth {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.8);
        }

        /* Modal Open State */
        body.modal-open {
            position: fixed;
            width: 100%;
            overflow: hidden;
        }

        /* Loading Spinner */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            border-top-color: #6366f1;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 0.5rem;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Tooltip */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 12px;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            pointer-events: none;
            z-index: 1000;
        }

        [data-tooltip]:hover:before {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-8px);
        }

        /* Focus States */
        .focus-ring:focus {
            outline: none;
            ring: 2px;
            ring-color: #6366f1;
            ring-offset: 2px;
        }
    </style>
</head>
<body class="min-h-screen text-slate-300 pb-24 lg:pb-0">
    <div id="fixed-background"></div>
    <div id="toast-container"></div>
    <div id="app"></div>
    
    <datalist id="tech-suggestions">
        <option value="Arduino Uno R3">
        <option value="Arduino Nano V3">
        <option value="ESP32 Dev Module">
        <option value="ESP8266 NodeMCU">
        <option value="Raspberry Pi 4">
        <option value="Raspberry Pi Pico W">
        <option value="STM32 Blue Pill">
        <option value="Resistor Kit">
        <option value="Resistor 220Ω">
        <option value="Resistor 1kΩ">
        <option value="Resistor 10kΩ">
        <option value="Capacitor 10uF">
        <option value="LED Red 5mm">
        <option value="WS2812B LED Strip">
        <option value="OLED 0.96 I2C">
        <option value="LCD 16x2">
        <option value="Servo SG90">
        <option value="Stepper NEMA17">
        <option value="Motor Driver L298N">
        <option value="HC-SR04 Ultrasonic">
        <option value="DHT11 Temperature">
        <option value="LiPo Battery 3.7V">
        <option value="Soldering Iron">
        <option value="Multimeter">
        <option value="Breadboard">
        <option value="Jumper Wires">
    </datalist>

    <script>
        // ==========================================
        // 1. CONFIGURATION & CONSTANTS
        // ==========================================
        const APP_PASSWORD = 'IV9769806390D';
        const DEFAULT_CATEGORY = 'Microcontroller';
        const DEFAULT_MIN_STOCK = 5;
        const LOCAL_STORAGE_KEYS = {
            DB_CONFIG: 'dbConfig',
            AUTH: 'auth',
            LAST_TAB: 'lastActiveTab'
        };

        let SUPABASE_URL = '';
        let SUPABASE_KEY = '';

        const categories = [
            'Actuators', 'Amplifiers', 'Antennas', 'Batteries', 'Breadboards', 'Buzzers',
            'Cables', 'Capacitors', 'Connectors', 'Crystals', 'Diodes', 'Displays',
            'Enclosures', 'Fans', 'Fuses', 'Hardware', 'Heat Sinks', 'ICs', 'Inductors',
            'Jumper Wires', 'Keypads', 'LEDs', 'Microcontrollers', 'Modules', 'Motors',
            'Oscillators', 'PCBs', 'Potentiometers', 'Power Supplies', 'Relays', 'Resistors',
            'Sensors', 'Servos', 'Speakers', 'Steppers', 'Switches', 'Transformers',
            'Transistors', 'Voltage Regulators', 'Wires', 'Miscellaneous'
        ].sort();

        // ==========================================
        // 2. STATE MANAGEMENT
        // ==========================================
        const state = {
            activeTab: localStorage.getItem(LOCAL_STORAGE_KEYS.LAST_TAB) || 'inventory',
            components: [],
            transactions: [],
            notes: [],
            images: [],
            searchTerm: '',
            filterCategory: 'All',
            logSearchTerm: '',
            logFilterType: 'All',
            logFromDate: '',
            logToDate: '',
            logFilterCategory: 'All',
            isAuthenticated: false,
            isLoading: false,
            showAddModal: false,
            showSetupModal: false,
            showStockModal: false,
            showHistoryModal: false,
            showNotesModal: false,
            showAddNoteModal: false,
            showStorageViewer: false,
            editingId: null,
            editingNoteId: null,
            stockAction: {
                id: null,
                type: 'IN',
                name: ''
            },
            historyComponent: {
                id: null,
                name: ''
            },
            dbConfig: {
                url: SUPABASE_URL,
                key: SUPABASE_KEY
            },
            formData: {
                name: '',
                category: DEFAULT_CATEGORY,
                value: '',
                quantity: '',
                location: '',
                notes: '',
                cost: '',
                minStock: DEFAULT_MIN_STOCK.toString(),
                datasheet: '',
                purchasedDate: '',
                partNumber: '',
                supplierUrl: '',
                image: null,
                imageUrl: ''
            },
            noteForm: {
                title: '',
                content: ''
            },
            sortBy: 'name',
            sortAsc: true,
            filterLowStock: false,
            scrollY: 0,
            imageStorageUsed: 0,
            lastUpdate: null
        };

        // ==========================================
        // 3. UTILITY FUNCTIONS
        // ==========================================
        class Utils {
            static debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            static throttle(func, limit) {
                let inThrottle;
                return function(...args) {
                    if (!inThrottle) {
                        func.apply(this, args);
                        inThrottle = true;
                        setTimeout(() => inThrottle = false, limit);
                    }
                };
            }

            static escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            static formatCurrency(amount) {
                return new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2
                }).format(amount);
            }

            static formatDate(dateString) {
                if (!dateString) return '--';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-IN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }

            static showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = 'toast slide-in-right';
                toast.textContent = message;
                
                const colors = {
                    success: 'bg-emerald-600/90',
                    error: 'bg-rose-600/90',
                    warning: 'bg-amber-600/90',
                    info: 'bg-indigo-600/90'
                };
                
                toast.classList.add(colors[type] || colors.info);
                
                container.appendChild(toast);
                
                setTimeout(() => toast.classList.add('show'), 10);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            static formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            static validateNumber(value, min = 0, max = Infinity) {
                const num = Number(value);
                return !isNaN(num) && num >= min && num <= max;
            }
        }

        // ==========================================
        // 4. INITIALIZATION
        // ==========================================
        function init() {
            // Load saved configuration
            const savedConfig = localStorage.getItem(LOCAL_STORAGE_KEYS.DB_CONFIG);
            const auth = sessionStorage.getItem(LOCAL_STORAGE_KEYS.AUTH);
            
            if (savedConfig) {
                try {
                    state.dbConfig = JSON.parse(savedConfig);
                } catch (e) {
                    console.error('Failed to parse saved config:', e);
                }
            }
            
            if (SUPABASE_URL && SUPABASE_KEY) {
                state.dbConfig = { url: SUPABASE_URL, key: SUPABASE_KEY };
            }
            
            if (auth === 'true') {
                state.isAuthenticated = true;
                if (state.dbConfig.url && state.dbConfig.key) {
                    loadData();
                }
            }
            
            renderApp();
            
            // Add global error handler
            window.addEventListener('error', handleGlobalError);
            window.addEventListener('unhandledrejection', handlePromiseRejection);
        }

        function handleGlobalError(event) {
            console.error('Global error:', event.error);
            Utils.showToast('An unexpected error occurred', 'error');
        }

        function handlePromiseRejection(event) {
            console.error('Unhandled promise rejection:', event.reason);
            Utils.showToast('Operation failed', 'error');
        }

        // ==========================================
        // 5. DATA MANAGEMENT
        // ==========================================
        async function loadData() {
            if (!state.dbConfig.url || !state.dbConfig.key) {
                Utils.showToast('Database not configured', 'warning');
                return;
            }

            state.isLoading = true;
            renderHeader();
            renderContent();

            const headers = {
                'apikey': state.dbConfig.key,
                'Authorization': 'Bearer ' + state.dbConfig.key,
                'Prefer': 'count=exact'
            };

            try {
                const [componentsRes, transactionsRes, notesRes] = await Promise.all([
                    fetch(state.dbConfig.url + '/rest/v1/components?select=*&order=name.asc', { headers }),
                    fetch(state.dbConfig.url + '/rest/v1/transactions?select=*,components(name,value,category)&order=created_at.desc', { headers }),
                    fetch(state.dbConfig.url + '/rest/v1/notes?select=*&order=created_at.desc', { headers })
                ]);

                if (!componentsRes.ok || !transactionsRes.ok || !notesRes.ok) {
                    throw new Error('Failed to fetch data');
                }

                const [components, transactions, notes] = await Promise.all([
                    componentsRes.json(),
                    transactionsRes.json(),
                    notesRes.json()
                ]);

                state.components = Array.isArray(components) ? components : [];
                state.transactions = Array.isArray(transactions) ? transactions : [];
                state.notes = Array.isArray(notes) ? notes : [];
                state.lastUpdate = new Date();
                
                Utils.showToast('Data loaded successfully', 'success');
            } catch (error) {
                console.error('Failed to load data:', error);
                Utils.showToast('Failed to load data. Check your connection.', 'error');
                state.components = [];
                state.transactions = [];
                state.notes = [];
            } finally {
                state.isLoading = false;
                renderApp();
            }
        }

        async function loadImages() {
            if (!state.dbConfig.url || !state.dbConfig.key) return;

            try {
                const listRes = await fetch(state.dbConfig.url + '/storage/v1/object/list/components/', {
                    method: 'POST',
                    headers: {
                        'apikey': state.dbConfig.key,
                        'Authorization': 'Bearer ' + state.dbConfig.key,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prefix: '',
                        limit: 100,
                        sortBy: { column: 'name', order: 'asc' }
                    })
                });

                if (!listRes.ok) throw new Error('Failed to fetch images');
                
                const data = await listRes.json();
                state.images = data || [];
                state.imageStorageUsed = 0;

                // Calculate total storage used
                for (const img of data) {
                    if (img.name === '.') continue;
                    
                    try {
                        const headRes = await fetch(
                            state.dbConfig.url + '/storage/v1/object/public/components/' + img.name,
                            {
                                method: 'HEAD',
                                headers: {
                                    'apikey': state.dbConfig.key,
                                    'Authorization': 'Bearer ' + state.dbConfig.key
                                }
                            }
                        );
                        
                        const size = parseInt(headRes.headers.get('content-length') || '0');
                        state.imageStorageUsed += size;
                    } catch (e) {
                        console.warn('Failed to get image size:', img.name);
                    }
                }
            } catch (error) {
                console.error('Failed to load images:', error);
                state.images = [];
            }
            
            renderModals();
        }

        // ==========================================
        // 6. RENDER FUNCTIONS
        // ==========================================
        function renderApp() {
            const app = document.getElementById('app');
            
            if (!state.isAuthenticated) {
                app.innerHTML = getLoginHTML();
                return;
            }

            if (!app.querySelector('#main-shell')) {
                app.innerHTML = `
                    <div id="main-shell">
                        <div id="header-container"></div>
                        <div id="content-container" class="max-w-7xl mx-auto p-4 md:p-8 fade-in"></div>
                    </div>
                    <div id="modals-container"></div>
                `;
            }

            renderHeader();
            renderContent();
            renderModals();
        }

        function renderHeader() {
            const container = document.getElementById('header-container');
            if (!container) return;

            const totalValue = state.components.reduce(
                (acc, c) => acc + (c.quantity * (c.cost_per_unit || 0)), 0
            );
            
            const lowStockCount = state.components.filter(
                c => c.quantity <= (c.min_stock_level || DEFAULT_MIN_STOCK)
            ).length;

            container.innerHTML = `
                <div class="sticky top-0 z-40 glass-header px-4 py-3 md:px-8 md:py-4">
                    <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                        <div class="flex items-center justify-between w-full md:w-auto gap-6">
                            <div class="flex items-center gap-3">
                                <div class="relative group">
                                    <h1 class="text-2xl font-black text-white tracking-tight select-none">
                                        Inventory<span class="animate-gradient-text">Master</span>
                                    </h1>
                                    <span class="absolute -top-2 -right-6 text-[10px] text-indigo-400 font-mono opacity-0 group-hover:opacity-100 transition-opacity">
                                        v2.1.0
                                    </span>
                                </div>
                                ${state.isLoading ? `
                                    <div class="loading-spinner w-5 h-5 border-2"></div>
                                ` : ''}
                            </div>
                            <div class="flex bg-slate-800/50 border border-white/10 p-1 rounded-xl">
                                <button onclick="switchTab('inventory')" 
                                        class="px-4 py-1.5 rounded-lg text-sm font-semibold transition-all ${state.activeTab === 'inventory' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}"
                                        data-tooltip="View Inventory">
                                    Items
                                </button>
                                <button onclick="switchTab('logs')" 
                                        class="px-4 py-1.5 rounded-lg text-sm font-semibold transition-all ${state.activeTab === 'logs' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}"
                                        data-tooltip="Transaction Logs">
                                    Logs
                                </button>
                                <button onclick="switchTab('notes')" 
                                        class="px-4 py-1.5 rounded-lg text-sm font-semibold transition-all ${state.activeTab === 'notes' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}"
                                        data-tooltip="Notes & Shopping List">
                                    Notes
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center gap-4 w-full md:w-auto">
                            <div class="grid grid-cols-3 gap-3 flex-1 md:flex-none">
                                <div class="bg-slate-800/50 border border-white/10 rounded-xl px-3 py-2 text-center min-w-[80px] hover-shine"
                                     data-tooltip="Total Items">
                                    <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Count</div>
                                    <div class="text-lg font-black text-white">${state.components.length}</div>
                                </div>
                                <div class="bg-slate-800/50 border border-white/10 rounded-xl px-3 py-2 text-center min-w-[80px] hover-shine"
                                     data-tooltip="Total Inventory Value">
                                    <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Value</div>
                                    <div class="text-lg font-black text-white">${Utils.formatCurrency(totalValue)}</div>
                                </div>
                                <button onclick="toggleLowStockFilter()" 
                                        class="bg-slate-800/50 border ${lowStockCount > 0 ? 'border-rose-500/30' : 'border-slate-500/30'} rounded-xl px-3 py-2 text-center min-w-[80px] hover-shine ${lowStockCount > 0 ? 'animate-pulse-slow' : ''}"
                                        data-tooltip="${lowStockCount > 0 ? `${lowStockCount} items below minimum stock` : 'All items in stock'}">
                                    <div class="text-[10px] ${lowStockCount > 0 ? 'text-rose-400' : 'text-slate-400'} font-bold uppercase tracking-wider">Alerts</div>
                                    <div class="text-lg font-black ${lowStockCount > 0 ? 'text-rose-500' : 'text-slate-500'}">${lowStockCount}</div>
                                </button>
                            </div>
                            <button onclick="state.showSetupModal = true; renderModals()" 
                                    class="w-12 h-12 flex items-center justify-center rounded-xl bg-slate-800/50 border border-white/10 text-slate-400 hover:text-white hover:bg-slate-700 transition relative overflow-hidden group hover-shine"
                                    data-tooltip="Settings">
                                <svg class="w-6 h-6 animate-[spin_10s_linear_infinite]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderContent() {
            const container = document.getElementById('content-container');
            if (!container) return;

            if (state.isLoading) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center min-h-[60vh]">
                        <div class="loading-spinner w-12 h-12 mb-4"></div>
                        <p class="text-slate-400">Loading inventory data...</p>
                    </div>
                `;
                return;
            }

            switch (state.activeTab) {
                case 'inventory':
                    renderInventory(container);
                    break;
                case 'logs':
                    renderLogs(container);
                    break;
                case 'notes':
                    renderNotes(container);
                    break;
            }
        }

        function renderInventory(container) {
            container.innerHTML = `
                <div id="search-controls" class="flex flex-col md:flex-row gap-3 mb-8">
                    <div class="relative flex-1 group">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-slate-400 group-focus-within:text-indigo-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                        <input type="text" id="static-search" 
                               oninput="handleSearch(this.value)" 
                               value="${Utils.escapeHtml(state.searchTerm)}"
                               placeholder="Search components..." 
                               class="block w-full pl-10 p-3.5 bg-slate-800/50 border border-slate-700 rounded-xl shadow-lg outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-white font-medium placeholder-slate-500 focus-ring">
                    </div>
                    <select onchange="state.filterCategory = this.value; updateList()" 
                            class="p-3.5 bg-slate-800/80 border border-slate-600 rounded-xl shadow-lg outline-none focus:ring-2 focus:ring-indigo-500 font-semibold text-slate-200 cursor-pointer hover:bg-slate-700 transition focus-ring">
                        <option value="All">All Categories</option>
                        ${categories.map(c => `
                            <option value="${c}" ${state.filterCategory === c ? 'selected' : ''}>
                                ${c}
                            </option>
                        `).join('')}
                    </select>
                    <select onchange="handleSort(this.value)" 
                            class="p-3.5 bg-slate-800/80 border border-slate-600 rounded-xl shadow-lg outline-none focus:ring-2 focus:ring-indigo-500 font-semibold text-slate-200 cursor-pointer hover:bg-slate-700 transition focus-ring">
                        <option value="name" ${state.sortBy === 'name' ? 'selected' : ''}>Name A-Z</option>
                        <option value="quantity" ${state.sortBy === 'quantity' ? 'selected' : ''}>Quantity Low-High</option>
                        <option value="cost_per_unit" ${state.sortBy === 'cost_per_unit' ? 'selected' : ''}>Cost Low-High</option>
                    </select>
                    <button onclick="openAddModal()" 
                            class="hidden md:flex bg-indigo-600 hover:bg-indigo-500 text-white px-6 rounded-xl font-bold shadow-lg shadow-indigo-500/30 transition-all items-center gap-2 hover-shine focus-ring">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>Add Item</span>
                    </button>
                    <button onclick="exportToCSV('inventory')" 
                            class="hidden md:flex bg-green-600 hover:bg-green-500 text-white px-6 rounded-xl font-bold shadow-lg shadow-green-500/30 transition-all items-center gap-2 hover-shine focus-ring">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>Export</span>
                    </button>
                </div>
               
                <div id="inventory-list-container" class="fade-in"></div>
                
                <button onclick="openAddModal()" 
                        class="mobile-only fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 text-white rounded-2xl shadow-xl shadow-indigo-900/50 flex items-center justify-center text-3xl pb-1 z-40 active:scale-90 transition-transform font-light border border-white/20 hover-shine focus-ring"
                        data-tooltip="Add New Item">
                    +
                </button>
            `;
            
            updateList();
        }

        function updateList() {
            const container = document.getElementById('inventory-list-container');
            if (!container) return;

            let filtered = state.components.filter(c => {
                const searchTerm = state.searchTerm.toLowerCase();
                const matchesSearch = c.name.toLowerCase().includes(searchTerm) ||
                                     (c.value && c.value.toLowerCase().includes(searchTerm)) ||
                                     (c.location && c.location.toLowerCase().includes(searchTerm)) ||
                                     (c.notes && c.notes.toLowerCase().includes(searchTerm)) ||
                                     (c.part_number && c.part_number.toLowerCase().includes(searchTerm)) ||
                                     (c.manufacturer && c.manufacturer.toLowerCase().includes(searchTerm));
                
                const matchesCategory = state.filterCategory === 'All' || c.category === state.filterCategory;
                const matchesLowStock = !state.filterLowStock || c.quantity <= (c.min_stock_level || DEFAULT_MIN_STOCK);
                
                return matchesSearch && matchesCategory && matchesLowStock;
            });

            // Apply sorting
            filtered.sort((a, b) => {
                let valA = a[state.sortBy];
                let valB = b[state.sortBy];
                
                if (typeof valA === 'string') valA = valA.toLowerCase();
                if (typeof valB === 'string') valB = valB.toLowerCase();
                
                if (valA < valB) return state.sortAsc ? -1 : 1;
                if (valA > valB) return state.sortAsc ? 1 : -1;
                return 0;
            });

            // Mobile View
            const mobileView = filtered.length === 0 ? `
                <div class="p-12 text-center text-slate-500 bg-white/5 rounded-xl border border-white/10">
                    <svg class="w-16 h-16 mx-auto mb-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-lg font-medium mb-2">No items found</p>
                    <p class="text-sm text-slate-400">Try adjusting your search or filters</p>
                </div>
            ` : filtered.map(component => renderMobileCard(component)).join('');

            // Desktop View
            const desktopView = filtered.length === 0 ? `
                <div class="p-12 text-center text-slate-500 bg-white/5 rounded-xl border border-white/10">
                    <svg class="w-16 h-16 mx-auto mb-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-lg font-medium mb-2">No items matching your criteria</p>
                    <p class="text-sm text-slate-400">Try adjusting your search or filters</p>
                </div>
            ` : filtered.map(component => renderDesktopRow(component)).join('');

            container.innerHTML = `
                <div class="mobile-only pb-24">
                    <div class="mb-4 text-sm text-slate-400">
                        Showing ${filtered.length} of ${state.components.length} items
                    </div>
                    ${mobileView}
                </div>
                <div class="desktop-only">
                    <div class="flex text-sm uppercase font-bold text-white px-4 py-3 tracking-wider bg-indigo-600 rounded-xl shadow-md sticky top-20 z-30">
                        <div class="w-1/5 pl-2">Value / Name</div>
                        <div class="w-1/6">Specification</div>
                        <div class="w-1/6">Part #</div>
                        <div class="w-1/6">Storage</div>
                        <div class="w-1/6 text-center">Current Stock</div>
                        <div class="w-1/5 text-right">Actions</div>
                    </div>
                    <div class="space-y-2 mt-4">
                        ${desktopView}
                    </div>
                </div>
            `;
        }

        function renderMobileCard(component) {
            const isLowStock = component.quantity <= (component.min_stock_level || DEFAULT_MIN_STOCK);
            const costPerUnit = component.cost_per_unit || 0;
            
            return `
                <div class="bg-white text-slate-800 p-5 mb-4 rounded-2xl shadow-lg shadow-black/5 relative overflow-hidden fade-in border border-slate-100 hover-shine hover-scale">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 ${isLowStock ? 'bg-rose-500' : 'bg-emerald-500'}"></div>
                    <div class="pl-3">
                        <div class="flex justify-between items-start mb-3">
                            <div class="min-w-0 flex-1 mr-3">
                                <h3 class="font-bold text-slate-900 text-lg leading-tight text-clamp">
                                    ${Utils.escapeHtml(component.value || component.name)}
                                </h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[10px] font-bold uppercase tracking-wider text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded border border-indigo-100">
                                        ${Utils.escapeHtml(component.category)}
                                    </span>
                                    ${isLowStock ? `
                                        <span class="text-[10px] font-bold uppercase tracking-wider text-rose-600 bg-rose-50 px-2 py-0.5 rounded border border-rose-100">
                                            Low Stock
                                        </span>
                                    ` : ''}
                                </div>
                            </div>
                            <div class="text-right flex-shrink-0">
                                <div class="text-3xl font-black text-slate-900 leading-none">${component.quantity}</div>
                                <div class="text-sm font-bold text-slate-500">${Utils.formatCurrency(costPerUnit)}/ea</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <div class="bg-slate-50 rounded-lg px-3 py-2 border border-slate-100">
                                <div class="text-[10px] uppercase text-slate-400 font-bold">Location</div>
                                <div class="text-sm font-semibold text-slate-700 text-clamp">
                                    ${Utils.escapeHtml(component.location || '--')}
                                </div>
                            </div>
                            <div class="bg-slate-50 rounded-lg px-3 py-2 border border-slate-100">
                                <div class="text-[10px] uppercase text-slate-400 font-bold">Spec</div>
                                <div class="text-sm font-semibold text-slate-700 text-clamp">
                                    ${Utils.escapeHtml(component.value || '--')}
                                </div>
                            </div>
                            <div class="bg-slate-50 rounded-lg px-3 py-2 border border-slate-100">
                                <div class="text-[10px] uppercase text-slate-400 font-bold">Part #</div>
                                <div class="text-sm font-semibold text-slate-700 text-clamp">
                                    ${Utils.escapeHtml(component.part_number || '--')}
                                </div>
                            </div>
                            <div class="bg-slate-50 rounded-lg px-3 py-2 border border-slate-100">
                                <div class="text-[10px] uppercase text-slate-400 font-bold">Purchased</div>
                                <div class="text-sm font-semibold text-slate-700 text-clamp">
                                    ${Utils.formatDate(component.purchased_date)}
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openStockModal(${component.id}, 'OUT', '${Utils.escapeHtml(component.name)}')" 
                                    class="flex-1 bg-rose-50 text-rose-600 py-2.5 rounded-xl font-bold border border-rose-100 active:scale-95 transition hover:bg-rose-100 hover-shine focus-ring"
                                    data-tooltip="Remove Stock">
                                <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/>
                                </svg>
                                Out
                            </button>
                            <button onclick="openStockModal(${component.id}, 'IN', '${Utils.escapeHtml(component.name)}')" 
                                    class="flex-1 bg-emerald-50 text-emerald-600 py-2.5 rounded-xl font-bold border border-emerald-100 active:scale-95 transition hover:bg-emerald-100 hover-shine focus-ring"
                                    data-tooltip="Add Stock">
                                <svg class="w-5 h-5 inline-block mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                In
                            </button>
                            <button onclick="openHistoryModal(${component.id}, '${Utils.escapeHtml(component.name)}')" 
                                    class="w-12 bg-yellow-50 text-yellow-600 rounded-xl font-bold border border-yellow-100 flex items-center justify-center active:scale-95 hover:bg-yellow-100 hover-shine focus-ring"
                                    data-tooltip="History">
                                H
                            </button>
                            <button onclick="openEditModal(${component.id})" 
                                    class="w-12 bg-slate-100 text-slate-600 rounded-xl font-bold border border-slate-200 active:scale-95 transition hover:bg-slate-200 hover-shine focus-ring"
                                    data-tooltip="Edit">
                                ✎
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDesktopRow(component) {
            const isLowStock = component.quantity <= (component.min_stock_level || DEFAULT_MIN_STOCK);
            const costPerUnit = component.cost_per_unit || 0;
            
            return `
                <div class="group bg-white text-slate-800 rounded-xl border border-slate-200 shadow-sm hover:shadow-lg hover:border-indigo-300 transition-all duration-200 p-4 mb-3 flex items-center justify-between hover-shine fade-in relative">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 rounded-l-xl ${isLowStock ? 'bg-rose-500' : 'bg-emerald-500'}"></div>
                    <div class="w-1/5 pr-4 pl-2">
                        <div class="font-bold text-slate-900 text-xl text-clamp">
                            ${Utils.escapeHtml(component.value || component.name)}
                        </div>
                        <span class="inline-block mt-1 text-xs font-bold uppercase tracking-wider text-indigo-700 bg-indigo-50 px-2 py-0.5 rounded-md border border-indigo-100">
                            ${Utils.escapeHtml(component.category)}
                        </span>
                    </div>
                   
                    <div class="w-1/6 overflow-hidden">
                        <div class="text-[11px] text-slate-400 font-bold uppercase tracking-wider mb-1">Spec</div>
                        <div class="font-semibold text-slate-800 truncate bg-slate-50 px-2 py-0.5 rounded border border-slate-100 text-base text-clamp">
                            ${Utils.escapeHtml(component.value || '--')}
                        </div>
                    </div>
                   
                    <div class="w-1/6 overflow-hidden">
                        <div class="text-[11px] text-slate-400 font-bold uppercase tracking-wider mb-1">Part #</div>
                        <div class="font-semibold text-slate-800 truncate text-base text-clamp">
                            ${Utils.escapeHtml(component.part_number || '--')}
                        </div>
                    </div>
                   
                    <div class="w-1/6">
                        <div class="text-[11px] text-slate-400 font-bold uppercase tracking-wider mb-1">Location</div>
                        <div class="font-semibold text-slate-800 truncate text-base text-clamp">
                            ${Utils.escapeHtml(component.location || '--')}
                        </div>
                    </div>
                   
                    <div class="w-1/6 flex items-center gap-3 justify-center">
                         <button onclick="openStockModal(${component.id}, 'OUT', '${Utils.escapeHtml(component.name)}')" 
                                 class="w-8 h-8 rounded-lg bg-rose-50 text-rose-600 font-bold hover:bg-rose-500 hover:text-white transition opacity-0 group-hover:opacity-100 border border-rose-100 hover-shine focus-ring"
                                 data-tooltip="Remove Stock">
                            -
                         </button>
                         <div class="text-2xl font-black text-slate-900 w-12 text-center ${isLowStock ? 'text-rose-600' : ''}">
                            ${component.quantity}
                         </div>
                         <button onclick="openStockModal(${component.id}, 'IN', '${Utils.escapeHtml(component.name)}')" 
                                 class="w-8 h-8 rounded-lg bg-emerald-50 text-emerald-600 font-bold hover:bg-emerald-500 hover:text-white transition opacity-0 group-hover:opacity-100 border border-emerald-100 hover-shine focus-ring"
                                 data-tooltip="Add Stock">
                            +
                         </button>
                    </div>
                    <div class="w-1/5 flex items-center justify-end gap-3">
                        <div class="font-mono text-slate-500 font-bold text-base mr-2">
                            ${Utils.formatCurrency(costPerUnit)}
                        </div>
                        <button onclick="openHistoryModal(${component.id}, '${Utils.escapeHtml(component.name)}')" 
                                class="p-2 text-yellow-600 hover:bg-yellow-50 rounded-lg transition hover-shine opacity-0 group-hover:opacity-100 focus-ring"
                                data-tooltip="History">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </button>
                        ${component.datasheet_url ? `
                            <a href="${component.datasheet_url}" target="_blank" 
                               class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition hover-shine focus-ring"
                               data-tooltip="Datasheet">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </a>
                        ` : ''}
                        ${component.image_url ? `
                            <a href="${component.image_url}" target="_blank" 
                               class="p-2 text-orange-600 hover:bg-orange-50 rounded-lg transition hover-shine focus-ring"
                               data-tooltip="Image">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </a>
                        ` : ''}
                        ${component.supplier_url ? `
                            <a href="${component.supplier_url}" target="_blank" 
                               class="p-2 text-purple-600 hover:bg-purple-50 rounded-lg transition hover-shine focus-ring"
                               data-tooltip="Supplier">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h18v18H3V3z"/>
                                </svg>
                            </a>
                        ` : ''}
                        <button onclick="openEditModal(${component.id})" 
                                class="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition hover-shine focus-ring"
                                data-tooltip="Edit">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // 7. MODAL MANAGEMENT
        // ==========================================
        function renderModals() {
            const container = document.getElementById('modals-container');
            if (!container) return;

            let html = '';

            // Add/Edit Component Modal
            if (state.showAddModal) {
                html += renderComponentModal();
            }

            // Stock Adjustment Modal
            if (state.showStockModal) {
                html += renderStockModal();
            }

            // History Modal
            if (state.showHistoryModal) {
                html += renderHistoryModal();
            }

            // Add/Edit Note Modal
            if (state.showAddNoteModal) {
                html += renderNoteModal();
            }

            // Setup Modal
            if (state.showSetupModal) {
                html += renderSetupModal();
            }

            // Storage Viewer Modal
            if (state.showStorageViewer) {
                html += renderStorageViewerModal();
            }

            container.innerHTML = html;

            // Handle modal open/close state
            const hasModal = state.showAddModal || state.showStockModal || 
                           state.showSetupModal || state.showHistoryModal || 
                           state.showAddNoteModal || state.showStorageViewer;

            if (hasModal) {
                state.scrollY = window.pageYOffset;
                document.body.classList.add('modal-open');
                document.body.style.top = `-${state.scrollY}px`;
                document.body.style.position = 'fixed';
                document.body.style.width = '100%';
            } else {
                const scrollY = document.body.style.top;
                document.body.classList.remove('modal-open');
                document.body.style.top = '';
                document.body.style.position = '';
                document.body.style.width = '';
                window.scrollTo(0, parseInt(scrollY || '0') * -1);
            }

            // Auto-focus first input in modal
            setTimeout(() => {
                const firstInput = container.querySelector('input, textarea, select');
                if (firstInput) firstInput.focus();
            }, 50);
        }

        function renderComponentModal() {
            const isEditing = !!state.editingId;
            const title = isEditing ? 'Edit Component' : 'Add Component';
            
            return `
                <div class="fixed inset-0 z-50 flex items-end md:items-center justify-center bg-slate-900/60 backdrop-blur-sm scale-in" 
                     onclick="if(event.target===this){state.showAddModal=false;renderModals()}">
                    <div class="bg-white w-full md:w-[600px] md:rounded-2xl rounded-t-2xl max-h-[90vh] overflow-y-auto shadow-2xl scale-in text-slate-800">
                        <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
                            <h2 class="text-xl font-bold text-slate-800">${title}</h2>
                            <button onclick="state.showAddModal=false;renderModals()" 
                                    class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 flex items-center justify-center font-bold transition hover-shine focus-ring">
                                &times;
                            </button>
                        </div>
                        <div class="p-6 space-y-5">
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">
                                    Name *
                                </label>
                                <input type="text" id="compName" list="tech-suggestions" 
                                       class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-indigo-500 transition focus-ring"
                                       value="${Utils.escapeHtml(state.formData.name)}" 
                                       oninput="state.formData.name=this.value" 
                                       placeholder="e.g. ESP32"
                                       required>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">
                                        Category
                                    </label>
                                    <input type="text" list="category-suggestions" 
                                           class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl font-medium outline-none focus-ring"
                                           value="${Utils.escapeHtml(state.formData.category)}" 
                                           oninput="state.formData.category=this.value">
                                    <datalist id="category-suggestions">
                                        ${categories.map(c => `<option value="${c}">`).join('')}
                                    </datalist>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">
                                        Value / Spec
                                    </label>
                                    <input type="text" 
                                           class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus-ring"
                                           value="${Utils.escapeHtml(state.formData.value)}" 
                                           oninput="state.formData.value=this.value"
                                           placeholder="e.g. 16MHz, 5V">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">
                                        Part Number
                                    </label>
                                    <input type="text" 
                                           class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus-ring"
                                           value="${Utils.escapeHtml(state.formData.partNumber)}" 
                                           oninput="state.formData.partNumber=this.value"
                                           placeholder="e.g. ESP32-WROOM-32">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">
                                        Date Purchased
                                    </label>
                                    <input type="date" 
                                           class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus-ring"
                                           value="${Utils.escapeHtml(state.formData.purchasedDate)}" 
                                           oninput="state.formData.purchasedDate=this.value">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">
                                        Quantity *
                                    </label>
                                    <input type="number" min="0"
                                           class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl font-mono font-bold text-lg outline-none focus-ring"
                                           value="${Utils.escapeHtml(state.formData.quantity)}" 
                                           oninput="state.formData.quantity=this.value"
                                           required>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">
                                        Cost (₹) *
                                    </label>
                                    <input type="number" min="0" step="0.01"
                                           class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus-ring"
                                           value="${Utils.escapeHtml(state.formData.cost)}" 
                                           oninput="state.formData.cost=this.value"
                                           required>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">
                                        Location
                                    </label>
                                    <input type="text" 
                                           class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus-ring"
                                           value="${Utils.escapeHtml(state.formData.location)}" 
                                           oninput="state.formData.location=this.value"
                                           placeholder="e.g. Shelf A1">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">
                                        Min Stock Level
                                    </label>
                                    <input type="number" min="0"
                                           class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus-ring"
                                           value="${Utils.escapeHtml(state.formData.minStock)}" 
                                           oninput="state.formData.minStock=this.value">
                                </div>
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">
                                    Datasheet URL
                                </label>
                                <input type="url" 
                                       class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none text-blue-600 placeholder:text-slate-400 focus-ring"
                                       value="${Utils.escapeHtml(state.formData.datasheet)}" 
                                       oninput="state.formData.datasheet=this.value" 
                                       placeholder="https://...">
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">
                                    Supplier URL
                                </label>
                                <input type="url" 
                                       class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none text-blue-600 placeholder:text-slate-400 focus-ring"
                                       value="${Utils.escapeHtml(state.formData.supplierUrl)}" 
                                       oninput="state.formData.supplierUrl=this.value" 
                                       placeholder="https://...">
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">
                                    Image
                                </label>
                                <input type="file" accept="image/*" 
                                       class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus-ring"
                                       onchange="state.formData.image=this.files[0]">
                                ${state.formData.imageUrl ? `
                                    <div class="mt-2">
                                        <img src="${state.formData.imageUrl}" alt="Current Image" 
                                             class="max-h-40 rounded-xl mx-auto">
                                        <div class="text-center mt-2">
                                            <button type="button" 
                                                    onclick="state.formData.imageUrl='';state.formData.image=null;renderModals()"
                                                    class="text-sm text-rose-600 hover:text-rose-700 font-medium">
                                                Remove Image
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">
                                    Notes
                                </label>
                                <textarea class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl outline-none focus-ring"
                                          oninput="state.formData.notes=this.value"
                                          placeholder="Additional notes about this component..."
                                          rows="3">${Utils.escapeHtml(state.formData.notes)}</textarea>
                            </div>
                            
                            <div class="pt-4">
                                <button onclick="${isEditing ? "saveComponent('PATCH', state.editingId)" : 'saveComponent()'}" 
                                        class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-500/30 hover:bg-indigo-500 transition transform active:scale-[0.98] hover-shine focus-ring">
                                    ${isEditing ? 'Update Item' : 'Add Item'}
                                </button>
                                ${isEditing ? `
                                    <button onclick="deleteComponent(${state.editingId})" 
                                            class="w-full text-rose-500 py-3 font-bold mt-2 hover:bg-rose-50 rounded-xl transition hover-shine focus-ring">
                                        Delete Permanently
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // 8. EVENT HANDLERS
        // ==========================================
        function handleLogin() {
            const passwordInput = document.getElementById('password');
            if (!passwordInput) return;
            
            if (passwordInput.value === APP_PASSWORD) {
                state.isAuthenticated = true;
                sessionStorage.setItem(LOCAL_STORAGE_KEYS.AUTH, 'true');
                
                if (state.dbConfig.url && state.dbConfig.key) {
                    loadData();
                } else {
                    state.showSetupModal = true;
                }
                renderApp();
            } else {
                Utils.showToast('Incorrect password', 'error');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        function switchTab(tab) {
            state.activeTab = tab;
            localStorage.setItem(LOCAL_STORAGE_KEYS.LAST_TAB, tab);
            renderHeader();
            renderContent();
        }

        const handleSearch = Utils.debounce((value) => {
            state.searchTerm = value.toLowerCase();
            updateList();
        }, 300);

        function handleSort(value) {
            state.sortBy = value;
            updateList();
        }

        function toggleLowStockFilter() {
            const lowStockCount = state.components.filter(
                c => c.quantity <= (c.min_stock_level || DEFAULT_MIN_STOCK)
            ).length;
            
            if (lowStockCount === 0) {
                Utils.showToast('No low stock items found', 'info');
                return;
            }
            
            state.filterLowStock = !state.filterLowStock;
            state.filterCategory = 'All';
            state.searchTerm = '';
            updateList();
            
            Utils.showToast(
                state.filterLowStock ? 
                `Showing ${lowStockCount} low stock items` : 
                'Showing all items',
                'info'
            );
        }

        // ==========================================
        // 9. CRUD OPERATIONS
        // ==========================================
        async function saveComponent(method, id) {
            method = method || 'POST';
            
            // Validation
            if (!state.formData.name.trim()) {
                Utils.showToast('Name is required', 'error');
                return;
            }
            
            if (!Utils.validateNumber(state.formData.quantity, 0)) {
                Utils.showToast('Valid quantity is required', 'error');
                return;
            }
            
            if (!Utils.validateNumber(state.formData.cost, 0)) {
                Utils.showToast('Valid cost is required', 'error');
                return;
            }

            const component = {
                name: state.formData.name.trim(),
                category: state.formData.category || DEFAULT_CATEGORY,
                value: state.formData.value?.trim() || null,
                quantity: parseInt(state.formData.quantity),
                location: state.formData.location?.trim() || null,
                notes: state.formData.notes?.trim() || null,
                cost_per_unit: parseFloat(state.formData.cost),
                min_stock_level: parseInt(state.formData.minStock) || DEFAULT_MIN_STOCK,
                datasheet_url: state.formData.datasheet?.trim() || null,
                purchased_date: state.formData.purchasedDate || null,
                part_number: state.formData.partNumber?.trim() || null,
                supplier_url: state.formData.supplierUrl?.trim() || null
            };

            if (method === 'POST') {
                component.date_added = new Date().toISOString();
            }

            // Handle image upload
            if (state.formData.image) {
                try {
                    const fileName = `${Date.now()}_${state.formData.image.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
                    const formData = new FormData();
                    formData.append('file', state.formData.image);
                    
                    const uploadRes = await fetch(
                        state.dbConfig.url + '/storage/v1/object/components/' + fileName,
                        {
                            method: 'POST',
                            headers: {
                                'apikey': state.dbConfig.key,
                                'Authorization': 'Bearer ' + state.dbConfig.key
                            },
                            body: state.formData.image
                        }
                    );
                    
                    if (!uploadRes.ok) throw new Error('Image upload failed');
                    
                    component.image_url = state.dbConfig.url + '/storage/v1/object/public/components/' + fileName;
                } catch (error) {
                    console.error('Image upload error:', error);
                    Utils.showToast('Failed to upload image', 'error');
                    return;
                }
            }

            const url = method === 'PATCH' 
                ? state.dbConfig.url + '/rest/v1/components?id=eq.' + id 
                : state.dbConfig.url + '/rest/v1/components';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'apikey': state.dbConfig.key,
                        'Authorization': 'Bearer ' + state.dbConfig.key,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(component)
                });

                if (!response.ok) throw new Error('Failed to save component');

                const data = await response.json();

                // Create initial transaction for new items
                if (method === 'POST') {
                    await fetch(state.dbConfig.url + '/rest/v1/transactions', {
                        method: 'POST',
                        headers: {
                            'apikey': state.dbConfig.key,
                            'Authorization': 'Bearer ' + state.dbConfig.key,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            component_id: data[0].id,
                            change_type: 'IN',
                            quantity_changed: component.quantity,
                            reason: 'Initial Add'
                        })
                    });
                }

                state.showAddModal = false;
                resetForm();
                await loadData();
                
                Utils.showToast(
                    method === 'POST' ? 'Component added successfully' : 'Component updated successfully',
                    'success'
                );
            } catch (error) {
                console.error('Save component error:', error);
                Utils.showToast('Failed to save component', 'error');
            }
        }

        // ==========================================
        // 10. INITIALIZATION
        // ==========================================
        window.addEventListener('DOMContentLoaded', init);
        
        // Export functions to global scope for onclick handlers
        window.handleLogin = handleLogin;
        window.switchTab = switchTab;
        window.handleSearch = handleSearch;
        window.handleSort = handleSort;
        window.toggleLowStockFilter = toggleLowStockFilter;
        window.openAddModal = () => {
            resetForm();
            state.showAddModal = true;
            renderModals();
        };
        
        // Note: Add other exported functions as needed...

    </script>
</body>
</html>
