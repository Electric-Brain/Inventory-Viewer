<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventory Master V10.2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: #e2e8f0; }
        #bg { position: fixed; inset: 0; z-index: -10; background: 
            linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px),
            radial-gradient(circle at 0% 0%, rgba(99,102,241,0.15), transparent 40%),
            radial-gradient(circle at 100% 100%, rgba(168,85,247,0.15), transparent 40%);
            background-size: 30px 30px, 30px 30px, cover, cover; }
        .glass { background: rgba(15,23,42,0.9); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .card { background: white; color: #1e293b; }
        @keyframes g { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        .grad-text { background: linear-gradient(90deg, #818cf8, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: g 4s infinite linear; }
        .hover-shine { position: relative; overflow: hidden; }
        .hover-shine::before { content: ''; position: absolute; inset: -50%; background: radial-gradient(circle, rgba(255,255,255,0.3), transparent 70%); opacity: 0; transition: 0.5s; }
        .hover-shine:hover::before { opacity: 1; transform: translate(100%,100%); }
    </style>
</head>
<body class="min-h-screen pb-24 lg:pb-0">
    <div id="bg"></div>
    <div id="app"></div>

    <script>
        const PWD = 'IV9769806390D';
        const cats = ['Microcontroller','Sensor','Display','LED','Resistor','Capacitor','Module','Motor','Power','Connector','Tool','Other'];
        const state = {
            tab: 'inventory', comps: [], logs: [], search: '', filter: 'All',
            auth: false, add: false, stock: false, setup: false, editId: null,
            stockAct: {id:null,type:'IN',name:''},
            db: {url:'',key:''},
            f: {name:'',cat:'Microcontroller',val:'',qty:'',loc:'',note:'',cost:'',min:'5',ds:'',date:'',mfr:'',sup:''}
        };

        function init() {
            const a = sessionStorage.getItem('auth')==='true';
            const d = localStorage.getItem('db'); if(d) state.db=JSON.parse(d);
            state.auth = a;
            if(a && state.db.url) load();
            render();
        }

        function load() {
            const h = {'apikey':state.db.key,'Authorization':'Bearer '+state.db.key};
            Promise.all([
                fetch(state.db.url+'/rest/v1/components?select=*', {headers:h}).then(r=>r.json()),
                fetch(state.db.url+'/rest/v1/transactions?select=*,components(name)&order=created_at.desc', {headers:h}).then(r=>r.json())
            ]).then(([c,l])=>{ state.comps=c||[]; state.logs=l||[]; render(); });
        }

        function render() {
            const app = document.getElementById('app');
            if(!state.auth) {
                app.innerHTML = `<div class="min-h-screen flex items-center justify-center">
                    <div class="card rounded-3xl p-10 shadow-2xl text-center max-w-sm w-full">
                        <h1 class="text-4xl font-black mb-4"><span class="grad-text">Inventory Master</span></h1>
                        <input type="password" id="p" class="w-full px-6 py-4 bg-gray-100 rounded-xl text-center text-xl" placeholder="Passcode" onkeydown="if(event.key==='Enter')login()">
                        <button onclick="login()" class="mt-6 w-full bg-indigo-600 text-white py-4 rounded-xl font-bold hover:bg-indigo-700">Enter</button>
                    </div>
                </div>`;
                return;
            }

            app.innerHTML = `
            <div class="sticky top-0 z-50 glass px-6 py-4">
                <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-8">
                        <h1 class="text-3xl font-black">Inventory<span class="grad-text">Master</span></h1>
                        <div class="flex bg-white/10 rounded-xl p-1">
                            <button onclick="state.tab='inventory';render()" class="px-6 py-2 rounded-lg font-bold ${state.tab==='inventory'?'bg-indigo-600 text-white':'text-gray-400'}">Items</button>
                            <button onclick="state.tab='logs';render()" class="px-6 py-2 rounded-lg font-bold ${state.tab==='logs'?'bg-indigo-600 text-white':'text-gray-400'}">Logs</button>
                        </div>
                    </div>
                    <div class="text-right text-sm">
                        <div>Total Items: <b>${state.comps.length}</b> | Value: <b>₹${state.comps.reduce((a,c)=>a+(c.quantity*(c.cost_per_unit||0)),0).toLocaleString()}</b></div>
                    </div>
                </div>
            </div>

            <div class="max-w-7xl mx-auto p-6">
                ${state.tab==='inventory'?inventoryHTML():logsHTML()}
            </div>

            <button onclick="openAdd()" class="fixed bottom-8 right-8 w-16 h-16 bg-indigo-600 text-white rounded-full text-4xl shadow-2xl hover-shine z-50">+</button>

            ${modalHTML()}
            `;

            if(state.tab==='inventory') setTimeout(updateList,0);
        }

        function inventoryHTML() {
            return `
            <div class="flex flex-col md:flex-row gap-4 mb-8">
                <input type="text" oninput="state.search=this.value.toLowerCase();updateList()" placeholder="Search..." class="flex-1 px-5 py-4 bg-white/10 rounded-xl">
                <select onchange="state.filter=this.value;updateList()" class="px-5 py-4 bg-white/10 rounded-xl">
                    <option>All</option>${cats.map(c=>`<option ${state.filter===c?'selected':''}>${c}</option>`).join('')}
                </select>
            </div>
            <div id="list"></div>`;
        }

        function updateList() {
            const filtered = state.comps
                .filter(c => (state.filter==='All'||c.category===state.filter) &&
                    (c.name.toLowerCase().includes(state.search)||
                     (c.value||'').toLowerCase().includes(state.search)||
                     (c.location||'').toLowerCase().includes(state.search)||
                     (c.manufacturer||'').toLowerCase().includes(state.search)))
                .sort((a,b)=>a.name.localeCompare(b.name));

            const html = filtered.map(c=>`
                <div class="card rounded-2xl p-6 mb-4 shadow hover-shine">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-2xl font-bold">${c.name}</h3>
                            <span class="text-xs px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full">${c.category}</span>
                        </div>
                        <div class="text-4xl font-black">${c.quantity}</div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mb-4">
                        <div><b>Location:</b> ${c.location||'-'}</div>
                        <div><b>Spec:</b> ${c.value||'-'}</div>
                        <div><b>Mfr:</b> ${c.manufacturer||'-'}</div>
                        <div><b>Bought:</b> ${c.purchased_date?new Date(c.purchased_date).toLocaleDateString():'-'}</div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="stock(${c.id},'OUT','${c.name}')" class="flex-1 bg-red-100 text-red-700 py-3 rounded-xl font-bold">-</button>
                        <button onclick="stock(${c.id},'IN','${c.name}')" class="flex-1 bg-green-100 text-green-700 py-3 rounded-xl font-bold">+</button>
                        ${c.datasheet_url?`<a href="${c.datasheet_url}" target="_blank" class="px-4 py-3 bg-blue-100 text-blue-700 rounded-xl">PDF</a>`:''}
                        ${c.supplier_url?`<a href="${c.supplier_url}" target="_blank" class="px-4 py-3 bg-purple-100 text-purple-700 rounded-xl">Buy</a>`:''}
                        <button onclick="edit(${c.id})" class="px-4 py-3 bg-gray-100 rounded-xl">Edit</button>
                    </div>
                </div>`).join('') || '<div class="text-center py-20 text-gray-500">No components found</div>';

            document.getElementById('list').innerHTML = html;
        }

        function logsHTML() {
            return `<div class="space-y-4">
                ${state.logs.map(l=>`
                <div class="card rounded-xl p-5 flex items-center gap-5 hover-shine">
                    <div class="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold ${l.change_type==='IN'?'bg-green-500':'bg-red-500'}">
                        ${l.change_type}
                    </div>
                    <div class="flex-1">
                        <div class="font-bold">${l.components?.name||'Deleted Item'}</div>
                        <div class="text-sm text-gray-600">${l.reason||'-'}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-mono text-lg">${l.change_type==='IN'?'+'+'-'}${l.quantity_changed}</div>
                        <div class="text-xs text-gray-500">${new Date(l.created_at).toLocaleDateString()}</div>
                    </div>
                </div>`).join('')}
            </div>`;
        }

        function modalHTML() {
            if(state.add || state.editId) {
                const c = state.editId ? state.comps.find(x=>x.id===state.editId) : null;
                if(c) Object.assign(state.f, {
                    name:c.name, cat:c.category, val:c.value||'', qty:c.quantity, loc:c.location||'', note:c.notes||'', cost:c.cost_per_unit||'', min:c.min_stock_level||5,
                    ds:c.datasheet_url||'', date:c.purchased_date||'', mfr:c.manufacturer||'', sup:c.supplier_url||''
                });
                return `
                <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" onclick="if(event.target===this){state.add=false;state.editId=null;render()}">
                    <div class="card rounded-2xl max-w-2xl w-full max-h-screen overflow-y-auto p-8">
                        <h2 class="text-2xl font-bold mb-6">${state.editId?'Edit':'Add'} Component</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" placeholder="Name" class="p-4 border rounded-xl" value="${state.f.name}" oninput="state.f.name=this.value">
                            <select class="p-4 border rounded-xl" onchange="state.f.cat=this.value">${cats.map(x=>`<option ${state.f.cat===x?'selected':''}>${x}</option>`).join('')}</select>
                            <input type="text" placeholder="Spec/Value" class="p-4 border rounded-xl" value="${state.f.val}" oninput="state.f.val=this.value">
                            <input type="text" placeholder="Manufacturer" class="p-4 border rounded-xl" value="${state.f.mfr}" oninput="state.f.mfr=this.value">
                            <input type="number" placeholder="Quantity" class="p-4 border rounded-xl" value="${state.f.qty}" oninput="state.f.qty=this.value">
                            <input type="number" placeholder="Cost ₹" class="p-4 border rounded-xl" value="${state.f.cost}" oninput="state.f.cost=this.value">
                            <input type="text" placeholder="Location" class="p-4 border rounded-xl" value="${state.f.loc}" oninput="state.f.loc=this.value">
                            <input type="date" class="p-4 border rounded-xl" value="${state.f.date}" oninput="state.f.date=this.value">
                            <input type="url" placeholder="Datasheet URL" class="p-4 border rounded-xl" value="${state.f.ds}" oninput="state.f.ds=this.value">
                            <input type="url" placeholder="Supplier/Buy URL" class="p-4 border rounded-xl" value="${state.f.sup}" oninput="state.f.sup=this.value">
                        </div>
                        <textarea placeholder="Notes" class="w-full p-4 border rounded-xl mt-4" oninput="state.f.note=this.value">${state.f.note}</textarea>
                        <div class="flex gap-4 mt-6">
                            <button onclick="save()" class="flex-1 bg-indigo-600 text-white py-4 rounded-xl font-bold hover-shine">Save</button>
                            ${state.editId?`<button onclick="del(${state.editId})" class="flex-1 bg-red-600 text-white py-4 rounded-xl font-bold">Delete</button>`:''}
                        </div>
                    </div>
                </div>`;
            }
            if(state.stock) {
                return `
                <div class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                    <div class="card rounded-3xl p-8 max-w-sm w-full text-center">
                        <div class="h-3 ${state.stockAct.type==='OUT'?'bg-red-500':'bg-green-500'} rounded-t-3xl -m-8 mb-6"></div>
                        <h3 class="text-2xl font-bold">${state.stockAct.type==='OUT'?'Remove':'Add'} Stock</h3>
                        <p class="my-4 text-lg">${state.stockAct.name}</p>
                        <div class="flex items-center justify-center gap-6 my-8">
                            <button onclick="this.nextElementSibling.stepDown()" class="w-14 h-14 bg-gray-200 rounded-full text-3xl">-</button>
                            <input type="number" value="1" min="1" class="text-5xl font-black w-24 text-center">
                            <button onclick="this.previousElementSibling.stepUp()" class="w-14 h-14 bg-gray-200 rounded-full text-3xl">+</button>
                        </div>
                        <input type="text" id="reason" placeholder="Reason" class="w-full p-4 border rounded-xl mb-6">
                        <div class="flex gap-4">
                            <button onclick="state.stock=false;render()" class="flex-1 py-4 bg-gray-200 rounded-xl font-bold">Cancel</button>
                            <button onclick="confirmStock()" class="flex-1 py-4 text-white rounded-xl font-bold ${state.stockAct.type==='OUT'?'bg-red-600':'bg-green-600'}">Confirm</button>
                        </div>
                    </div>
                </div>`;
            }
            return '';
        }

        function login() {
            if(document.getElementById('p').value===PWD) {
                state.auth=true; sessionStorage.setItem('auth','true');
                if(state.db.url) load(); else state.setup=true;
                render();
            } else alert('Wrong');
        }

        function openAdd() { state.f = {name:'',cat:'Microcontroller',val:'',qty:'',loc:'',note:'',cost:'',min:'5',ds:'',date:'',mfr:'',sup:''}; state.editId=null; state.add=true; render(); }
        function edit(id) { state.editId=id; state.add=true; render(); }
        function stock(id,type,name) { state.stock=true; state.stockAct={id,type,name}; render(); }

        function save() {
            const comp = {
                name:state.f.name, category:state.f.cat, value:state.f.val||null,
                quantity:+state.f.qty||0, location:state.f.loc||null, notes:state.f.note||null,
                cost_per_unit:+state.f.cost||0, min_stock_level:+state.f.min||5,
                datasheet_url:state.f.ds||null, purchased_date:state.f.date||null,
                manufacturer:state.f.mfr||null, supplier_url:state.f.sup||null
            };
            const method = state.editId?'PATCH':'POST';
            const url = state.editId ? `${state.db.url}/rest/v1/components?id=eq.${state.editId}` : `${state.db.url}/rest/v1/components`;
            fetch(url, {method, headers:{'apikey':state.db.key,'Authorization':'Bearer '+state.db.key,'Content-Type':'application/json','Prefer':'return=representation'}, body:JSON.stringify(comp)})
                .then(r=>r.json()).then(()=>{ state.add=false; state.editId=null; load(); });
        }

        function del(id) {
            if(confirm('Delete forever?')) {
                fetch(`${state.db.url}/rest/v1/components?id=eq.${id}`, {method:'DELETE', headers:{'apikey':state.db.key,'Authorization':'Bearer '+state.db.key}})
                    .then(()=>{ state.add=false; load(); });
            }
        }

        function confirmStock() {
            const qty = +document.querySelector('#reason').previousElementSibling.previousElementSibling.value;
            const reason = document.getElementById('reason').value || (state.stockAct.type==='OUT'?'Used':'Restock');
            const comp = state.comps.find(c=>c.id===state.stockAct.id);
            if(state.stockAct.type==='OUT' && comp.quantity < qty) return alert('Not enough');
            const newQty = state.stockAct.type==='IN' ? comp.quantity + qty : comp.quantity - qty;
            fetch(`${state.db.url}/rest/v1/components?id=eq.${state.stockAct.id}`, {method:'PATCH', headers:{'apikey':state.db.key,'Authorization':'Bearer '+state.db.key,'Content-Type':'application/json'}, body:JSON.stringify({quantity:newQty})})
                .then(()=>fetch(`${state.db.url}/rest/v1/transactions`, {method:'POST', headers:{'apikey':state.db.key,'Authorization':'Bearer '+state.db.key,'Content-Type':'application/json'}, body:JSON.stringify({component_id:state.stockAct.id,change_type:state.stockAct.type,quantity_changed:qty,reason})}))
                .then(()=>{ state.stock=false; load(); });
        }

        window.onload = init;
    </script>
</body>
</html>
