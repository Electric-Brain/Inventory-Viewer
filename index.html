<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electronics Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app"></div>

    <script>
        var APP_PASSWORD = 'IV9769806390D';
        var SUPABASE_URL = '';
        var SUPABASE_KEY = '';
        
        var categories = ['Microcontroller', 'Display', 'Sensor', 'LED', 'Resistor', 'Capacitor', 'IC', 'Module', 'Buzzer', 'Motor', 'Power Supply', 'Transistor', 'Diode', 'Other'];

        var state = {
            components: [],
            searchTerm: '',
            filterCategory: 'All',
            isAuthenticated: false,
            loading: false,
            showAddModal: false,
            showSetupModal: false,
            editingId: null,
            dbConfig: { url: SUPABASE_URL, key: SUPABASE_KEY },
            formData: { name: '', category: 'Microcontroller', value: '', quantity: '', location: '', notes: '', datePurchased: '' }
        };

        function init() {
            var auth = sessionStorage.getItem('auth');
            var savedConfig = localStorage.getItem('dbConfig');
            
            if (SUPABASE_URL && SUPABASE_KEY) {
                state.dbConfig = { url: SUPABASE_URL, key: SUPABASE_KEY };
                localStorage.setItem('dbConfig', JSON.stringify(state.dbConfig));
            } else if (savedConfig) {
                state.dbConfig = JSON.parse(savedConfig);
            }
            
            if (auth === 'true') {
                state.isAuthenticated = true;
                if (state.dbConfig.url && state.dbConfig.key) {
                    loadFromDatabase();
                }
            }
            render();
        }

        function loadFromDatabase() {
            state.loading = true;
            render();
            
            fetch(state.dbConfig.url + '/rest/v1/components?select=*&order=id.desc', {
                headers: { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key }
            }).then(function(r) {
                if (r.ok) return r.json();
                alert('Failed to connect to database');
                throw new Error('DB Error');
            }).then(function(data) {
                state.components = data;
                state.loading = false;
                render();
            }).catch(function() {
                state.loading = false;
                render();
            });
        }

        function saveToDatabase(component, method, id) {
            method = method || 'POST';
            state.loading = true;
            render();
            
            var url = method === 'PATCH' ? state.dbConfig.url + '/rest/v1/components?id=eq.' + id : state.dbConfig.url + '/rest/v1/components';
            
            fetch(url, {
                method: method,
                headers: { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                body: JSON.stringify(component)
            }).then(function(r) {
                if (r.ok) loadFromDatabase();
                else { alert('Failed to save'); state.loading = false; render(); }
            }).catch(function() {
                alert('Error saving');
                state.loading = false;
                render();
            });
        }

        function deleteFromDatabase(id) {
            if (!confirm('Delete this component?')) return;
            state.loading = true;
            render();
            
            fetch(state.dbConfig.url + '/rest/v1/components?id=eq.' + id, {
                method: 'DELETE',
                headers: { 'apikey': state.dbConfig.key, 'Authorization': 'Bearer ' + state.dbConfig.key }
            }).then(function(r) {
                if (r.ok) loadFromDatabase();
                else { alert('Failed to delete'); state.loading = false; render(); }
            });
        }

        function handleLogin() {
            var pw = document.getElementById('password').value;
            if (pw === APP_PASSWORD) {
                state.isAuthenticated = true;
                sessionStorage.setItem('auth', 'true');
                if (state.dbConfig.url) loadFromDatabase();
                else { state.showSetupModal = true; render(); }
            } else {
                alert('Incorrect password!');
            }
        }

        function saveDbConfig() {
            if (!state.dbConfig.url || !state.dbConfig.key) {
                alert('Please fill in both fields');
                return;
            }
            localStorage.setItem('dbConfig', JSON.stringify(state.dbConfig));
            state.showSetupModal = false;
            loadFromDatabase();
        }

        function handleAddComponent() {
            if (!state.formData.name || !state.formData.quantity) {
                alert('Please fill name and quantity');
                return;
            }
            var comp = {
                name: state.formData.name,
                category: state.formData.category,
                value: state.formData.value || null,
                quantity: parseInt(state.formData.quantity),
                location: state.formData.location || null,
                notes: state.formData.notes || null,
                date_purchased: state.formData.datePurchased || null,
                date_added: new Date().toISOString()
            };
            saveToDatabase(comp);
            resetForm();
        }

        function handleUpdateComponent() {
            var comp = {
                name: state.formData.name,
                category: state.formData.category,
                value: state.formData.value || null,
                quantity: parseInt(state.formData.quantity),
                location: state.formData.location || null,
                notes: state.formData.notes || null,
                date_purchased: state.formData.datePurchased || null
            };
            saveToDatabase(comp, 'PATCH', state.editingId);
            resetForm();
        }

        function handleEditClick(id) {
            var comp = null;
            for (var i = 0; i < state.components.length; i++) {
                if (state.components[i].id === id) { comp = state.components[i]; break; }
            }
            if (!comp) return;
            state.formData = {
                name: comp.name,
                category: comp.category,
                value: comp.value || '',
                quantity: comp.quantity.toString(),
                location: comp.location || '',
                notes: comp.notes || '',
                datePurchased: comp.date_purchased || ''
            };
            state.editingId = comp.id;
            state.showAddModal = true;
            render();
        }

        function resetForm() {
            state.formData = { name: '', category: 'Microcontroller', value: '', quantity: '', location: '', notes: '', datePurchased: '' };
            state.editingId = null;
            state.showAddModal = false;
            render();
        }

        function getLowStockCount() {
            var cnt = 0;
            for (var i = 0; i < state.components.length; i++) {
                if (state.components[i].quantity <= 5) cnt++;
            }
            return cnt;
        }

        function getFilteredComponents() {
            var filtered = [];
            for (var i = 0; i < state.components.length; i++) {
                var c = state.components[i];
                var matchSearch = c.name.toLowerCase().indexOf(state.searchTerm.toLowerCase()) !== -1 || (c.value && c.value.toLowerCase().indexOf(state.searchTerm.toLowerCase()) !== -1);
                var matchCat = state.filterCategory === 'All' || c.category === state.filterCategory;
                if (matchSearch && matchCat) filtered.push(c);
            }
            return filtered;
        }

        function esc(txt) {
            var div = document.createElement('div');
            div.textContent = txt;
            return div.innerHTML;
        }

        function render() {
            var app = document.getElementById('app');
            if (!state.isAuthenticated) {
                app.innerHTML = '<div class="min-h-screen flex items-center justify-center p-4"><div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md"><h1 class="text-2xl font-bold text-center mb-6">Electronics Inventory</h1><input type="password" id="password" placeholder="Enter Password" class="w-full px-4 py-3 border rounded-lg mb-4" onkeypress="if(event.key===\'Enter\')handleLogin()"/><button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 font-semibold">Login</button></div></div>';
                return;
            }

            var filtered = getFilteredComponents();
            var lowStock = getLowStockCount();
            var rows = '';
            
            if (state.loading) {
                rows = '<tr><td colspan="6" class="px-4 py-8 text-center">Loading...</td></tr>';
            } else if (filtered.length === 0) {
                rows = '<tr><td colspan="6" class="px-4 py-8 text-center">No components found</td></tr>';
            } else {
                for (var i = 0; i < filtered.length; i++) {
                    var c = filtered[i];
                    rows += '<tr class="border-b hover:bg-gray-50"><td class="px-4 py-3 text-sm font-medium">' + esc(c.name) + '</td><td class="px-4 py-3 text-sm"><span class="px-2 py-1 bg-indigo-100 text-indigo-800 rounded text-xs">' + esc(c.category) + '</span></td><td class="px-4 py-3 text-sm">' + (c.value ? esc(c.value) : '-') + '</td><td class="px-4 py-3 text-sm"><span class="font-semibold ' + (c.quantity <= 5 ? 'text-red-600' : '') + '">' + c.quantity + '</span></td><td class="px-4 py-3 text-sm">' + (c.location ? esc(c.location) : '-') + '</td><td class="px-4 py-3 text-sm"><button onclick="handleEditClick(' + c.id + ')" class="text-blue-600 mr-2">Edit</button><button onclick="deleteFromDatabase(' + c.id + ')" class="text-red-600">Delete</button></td></tr>';
                }
            }

            var catOpts = '<option value="All">All Categories</option>';
            for (var i = 0; i < categories.length; i++) {
                catOpts += '<option value="' + categories[i] + '" ' + (state.filterCategory === categories[i] ? 'selected' : '') + '>' + categories[i] + '</option>';
            }

            var html = '<div class="p-6"><div class="max-w-7xl mx-auto"><div class="bg-white rounded-lg shadow-lg p-6"><div class="flex justify-between items-center mb-6 flex-wrap gap-4"><div><h1 class="text-3xl font-bold">Electronics Inventory</h1><p class="text-gray-600 mt-1">Total: ' + state.components.length + '</p></div><div class="flex gap-2"><button onclick="loadFromDatabase()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Refresh</button><button onclick="state.showSetupModal=true;render()" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">DB Config</button><button onclick="state.showAddModal=true;render()" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Add Component</button></div></div>';

            if (lowStock > 0) {
                html += '<div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6"><p class="text-yellow-800"><strong>' + lowStock + '</strong> component(s) have low stock</p></div>';
            }

            html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"><input type="text" placeholder="Search..." value="' + esc(state.searchTerm) + '" oninput="state.searchTerm=this.value;render()" class="px-4 py-2 border rounded"/><select onchange="state.filterCategory=this.value;render()" class="px-4 py-2 border rounded">' + catOpts + '</select></div><table class="w-full"><thead><tr class="bg-gray-50 border-b"><th class="px-4 py-3 text-left text-sm font-semibold">Name</th><th class="px-4 py-3 text-left text-sm font-semibold">Category</th><th class="px-4 py-3 text-left text-sm font-semibold">Value</th><th class="px-4 py-3 text-left text-sm font-semibold">Quantity</th><th class="px-4 py-3 text-left text-sm font-semibold">Location</th><th class="px-4 py-3 text-left text-sm font-semibold">Actions</th></tr></thead><tbody>' + rows + '</tbody></table></div></div>';

            if (state.showSetupModal) {
                html += '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showSetupModal=false;render()}"><div class="bg-white rounded-lg p-6 w-full max-w-2xl" onclick="event.stopPropagation()"><h2 class="text-2xl font-bold mb-4">Database Configuration</h2><div class="space-y-4"><div><label class="block text-sm font-medium mb-1">Supabase URL</label><input type="text" value="' + esc(state.dbConfig.url) + '" oninput="state.dbConfig.url=this.value" class="w-full px-3 py-2 border rounded" placeholder="https://xxxxx.supabase.co"/></div><div><label class="block text-sm font-medium mb-1">Supabase API Key</label><input type="text" value="' + esc(state.dbConfig.key) + '" oninput="state.dbConfig.key=this.value" class="w-full px-3 py-2 border rounded" placeholder="eyJhbGc..."/></div><div class="bg-blue-50 p-4 text-sm"><p class="font-semibold mb-2">Setup:</p><ol class="list-decimal list-inside space-y-1"><li>Create account at supabase.com</li><li>Create new project</li><li>Go to Settings → API</li><li>Copy URL and anon key</li><li>Run this SQL:</li></ol><pre class="bg-gray-800 text-white p-3 rounded mt-2 text-xs">CREATE TABLE components (\n  id BIGSERIAL PRIMARY KEY,\n  name TEXT NOT NULL,\n  category TEXT NOT NULL,\n  value TEXT,\n  quantity INTEGER NOT NULL,\n  location TEXT,\n  notes TEXT,\n  date_purchased DATE,\n  date_added TIMESTAMPTZ DEFAULT NOW()\n);</pre></div></div><div class="flex gap-3 mt-6"><button onclick="saveDbConfig()" class="flex-1 bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 font-semibold">Save</button><button onclick="state.showSetupModal=false;render()" class="flex-1 bg-gray-200 py-2 rounded hover:bg-gray-300 font-semibold">Cancel</button></div></div></div>';
            }

            if (state.showAddModal) {
                var catFormOpts = '';
                for (var i = 0; i < categories.length; i++) {
                    catFormOpts += '<option value="' + categories[i] + '" ' + (state.formData.category === categories[i] ? 'selected' : '') + '>' + categories[i] + '</option>';
                }
                html += '<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this)resetForm()"><div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-screen overflow-y-auto" onclick="event.stopPropagation()"><h2 class="text-2xl font-bold mb-4">' + (state.editingId ? 'Edit' : 'Add') + ' Component</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium mb-1">Name *</label><input type="text" value="' + esc(state.formData.name) + '" oninput="state.formData.name=this.value" class="w-full px-3 py-2 border rounded" placeholder="Arduino Uno"/></div><div><label class="block text-sm font-medium mb-1">Category *</label><select onchange="state.formData.category=this.value" class="w-full px-3 py-2 border rounded">' + catFormOpts + '</select></div><div><label class="block text-sm font-medium mb-1">Value</label><input type="text" value="' + esc(state.formData.value) + '" oninput="state.formData.value=this.value" class="w-full px-3 py-2 border rounded" placeholder="10kΩ"/></div><div><label class="block text-sm font-medium mb-1">Quantity *</label><input type="number" value="' + esc(state.formData.quantity) + '" oninput="state.formData.quantity=this.value" class="w-full px-3 py-2 border rounded" min="0"/></div><div><label class="block text-sm font-medium mb-1">Location</label><input type="text" value="' + esc(state.formData.location) + '" oninput="state.formData.location=this.value" class="w-full px-3 py-2 border rounded" placeholder="Box A"/></div><div><label class="block text-sm font-medium mb-1">Date Purchased</label><input type="date" value="' + esc(state.formData.datePurchased) + '" oninput="state.formData.datePurchased=this.value" class="w-full px-3 py-2 border rounded"/></div><div class="md:col-span-2"><label class="block text-sm font-medium mb-1">Notes</label><textarea oninput="state.formData.notes=this.value" class="w-full px-3 py-2 border rounded" rows="3">' + esc(state.formData.notes) + '</textarea></div></div><div class="flex gap-3 mt-6"><button onclick="' + (state.editingId ? 'handleUpdateComponent()' : 'handleAddComponent()') + '" class="flex-1 bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 font-semibold">' + (state.editingId ? 'Update' : 'Add') + '</button><button onclick="resetForm()" class="flex-1 bg-gray-200 py-2 rounded hover:bg-gray-300 font-semibold">Cancel</button></div></div></div>';
            }

            html += '</div>';
            app.innerHTML = html;
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
